<HTML>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HEAD>
</HEAD>
<BODY>
<!--&lt;!&ndash;[if lt IE 9]>-->
<!--<script type="text/javascript" src="lib/jqplot/excanvas.js"></script>-->
<!--<![endif]&ndash;&gt;-->
<!--<script type="text/javascript" src="lib/jqplot/jquery.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/jquery.jqplot.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.barRenderer.min.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.categoryAxisRenderer.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.pointLabels.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/plugins/jqplot.logAxisRenderer.js"></script>-->
<!--<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css"/>-->



<script type="text/javascript" src="lib/webdetails/cdf/Base.js"></script>
<script type="text/javascript" src="lib/webdetails/cdf/jquery.js"></script>
<script type="text/javascript" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="text/javascript" src="lib/webdetails/data/q01-01.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="text/javascript" src="lib/webdetails/pvc/pvc.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcData.js"></script>

<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="text/javascript" src="lib/webdetails/pvcDocUtils.js"></script>




<!--<script type="text/javascript" src="lib/js/jquery-1.7.js"></script>-->
<!--<script type="text/javascript" src="lib/jqplot/jquery.jqplot.min.js"></script>-->
<!--<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css" />-->


<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css"
	  rel="stylesheet"/>
<script type="text/javascript"
		src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>


<script type="text/javascript" src="js/rest/RestConfig.js"></script>
<script type="text/javascript" src="js/CNV.js"></script>
<script type="text/javascript" src="js/aDate.js"></script>
<script type="text/javascript" src="js/aColour.js"></script>
<script type="text/javascript" src="js/Test2.js"></script>
<script type="text/javascript" src="js/MozillaPrograms.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/Debug.js"></script>

<script type="text/javascript" src="js/MVEL.js"></script>
<script type="text/javascript" src="js/SQL.js"></script>
<script type="text/javascript" src="js/SQL.aggregate.js"></script>
<script type="text/javascript" src="js/SQL.column.js"></script>
<script type="text/javascript" src="js/SQL.cube.js"></script>
<script type="text/javascript" src="js/SQL.domain.js"></script>
<script type="text/javascript" src="js/charts/aChart.js"></script>


<script type="text/javascript" src="js/charts/HelperFunctions.js"></script>
<script type="text/javascript" src="js/rest/RestQuery.js"></script>
<script type="text/javascript" src="js/charts/Status.js"></script>
<script type="text/javascript" src="js/charts/DataSet.js"></script>
<script type="text/javascript" src="js/charts/RangeCharts.js"></script>
<script type="text/javascript" src="js/charts/RangeIterator.js"></script>
<script type="text/javascript" src="js/charts/DateRangeIterator.js"></script>

<script type="text/javascript" src="js/filters/Filter.js"></script>
<script type="text/javascript" src="js/filters/ComponentFilter.js"></script>
<script type="text/javascript" src="js/filters/ProductFilter.js"></script>
<script type="text/javascript" src="js/filters/ProgramFilter.js"></script>
<script type="text/javascript" src="js/filters/CustomFilters.js"></script>
<script type="text/javascript" src="js/filters/GUIFilters.js"></script>

<table style="width: 100%;">
	<tr>
		<td style="width: 300px;  vertical-align:text-top;">
			<div id="filters" class="menu"></div>
			<div id="testMessage"></div>
		</td>
		<td style="vertical-align:text-top;">
			<table style="margin-left: auto; margin-right: auto; border: 0px solid black;">
				<tr>
					<td style="width: 800px; height: 100px; margin-left: auto; margin-right: auto;">
						<div style="text-align: center;font:10px arial,sans-serif;">
							Start Date <input type="text" id="startDate">
							<input type="text" id="endDate"> End Date
						</div>
					</td>
				</tr>
			</table>
			<table style="margin-left: auto; margin-right: auto; border: 1px solid black;">
				<tr>
					<td style="width: 800px; height: 400px; margin-left: auto; margin-right: auto;">
						<div id="chart"></div>
					</td>
				</tr>
				<tr>
					<td>
						<div id="status"
							 style="text-align: center; font:10px arial,sans-serif;">
							Chart Loading...
						</div>
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
<div id="info"></div>
<div id="description"></div>
<div id="report"></div>

<script type="text/javascript">

GUI.GetURLState();

var rangeChart = null;

var esQuery={
	"query":{"filtered":{
		"query": {
			"match_all" : {}
		},
		"filter" : {
			"and":[
				{"terms" : { "keywords" : ["crash", "topcrash", "regression"]}},
				{"terms" : {"bug_status" : ["resolved", "verified", "closed"]}},
				{"not": {"terms":{"previous_values.bug_status_value": ["resolved", "verified", "closed"]}}},
				{"range":{"modified_ts":{"gte":Date.now().floor("month").add("-2year")}}}
//				,{"range":{"bug_id":{"gte":600000}}}
			]
		}
	}},
	"from" : 0,
	"size" : 0,
	"sort" : [],
	"facets":{
		"closed" : {
			"terms" : {
				"script_field":new MVEL().code({
					"from":"doc",
					"select":[
						{"name":"bug_id", value:"doc.bug_id"},
						{"name":"created_ts", value:"doc.created_ts"},
						{"name":"modified_ts", value:"doc.modified_ts"}
					]
				}),
				"size":10000
			}
		}
	}
};

status.message("Calling ES");

RestQuery.Run(
	{
		"success" : function(requestObj, data){
			status.message("Formatting ES Data");
			var closed = CNV.ESFacet2List(data.facets.closed);

			var ages = new SQL().calc2List({
				"from":
					closed,
				"select":[
					{"name":"closed_time", "value":"modified_ts", "operation":"minimum"},
					{"name":"age", "value":"modified_ts-created_ts", "operation":"minimum"}
				],
				"facets":[
					{"name":"bug_id", "value":"bug_id"}
				]
			}).list;

			status.message("Tally into interval buckets");
			var chartCube = new SQL().calc2Cube({
				"name":"Bug Age For Crash",
				"from": ages,
				"select": {"name":"count", "value":"1", "operation":"count"},
				"facets":[
					{"name":"Cohort", "value":"Date.newInstance(closed_time)", "domain":{"type":"time", "min":Date.now().floor("month").add("-2year"), "max":Date.now().floor("month"), "interval":"6month", format:"NNN yyyy"}},
					{"name":"Age", "value":"Duration.newInstance(age)", "allowNulls":true, "domain":{"type":"duration", "min":0, "max":"6week", "interval":"week"}}
				]
			});

			SQL.normalizeByCohort(chartCube);



//
//			var avgCohort=new SQL().calc2List({
//				"from":focusData.list,
//				"select":{"name":"Average", "value":"count", "operation":"average"},
//				"facets":[
//					{"name":"Cohort", "value":"Cohort.value", "domain":{"type":"time", "min":Date.now().floor("month").add("-2year"), "max":Date.now().floor("month"), "interval":"6month", format:"NNN yyyy"}}
//				]
//			});
//
//			var avgAge=new SQL().calc2List({
//				"from":focusData.list,
//				"select":{"name":"Average", "value":"count", "operation":"average"},
//				"facets":[
//					{"name":"Age", "value":"Age.value", "domain":{"type":"duration", "min":0, "max":"3week", "interval":"day"}}
//				]
//			});
//
//			var normalized=new SQL().calc2List({
//				"from":focusData.list,
//				"select": {"name":"nCount", "value":"count/a.Average/c.Average", "operation":"none"},
//				"facets":[
//					{"name":"Cohort", "value":"Cohort.value", "domain":{"name":"c", "type":"set", "key":"Cohort.value", "partitions":avgCohort.list}},
//					{"name":"Age", "value":"Age.value", "domain":{"name":"a", "type":"set", "key":"Age.value", "partitions":avgAge.list}}
//				]
//			});

			



//			var chartCube2 = new SQL().calc2Cube({
//				"name":"Bug Age For Crash",
//				"from": ages,
//				"select": {"name":"count", "value":"1", "operation":"count"},
//				"facets":[
//					{"name":"Cohort", "value":"Date.newInstance(closed_time)", "domain":{"type":"time", "min":Date.now().add("-2year"), "max":Date.now().add("-1second"), "interval":"6month", format:"NNN yyyy"}},
//					{"name":"Age", "value":"Duration.newInstance(age)", "domain":{"type":"duration", "min":0, "max":"3week", "interval":"day"}}
//				]//,
////				"where":"duration.value!=null && age>0"
//			});




			status.message("Make chart");
			aChart.showCCC({
				"id":"chart",
				"type":"bar",
				"cube":chartCube
			});
			status.message("Done");


		}

	},
	0,
	esQuery
);

var filterUI = null;

//	$(document).ready(function(){
//			GUI.setup();
//			createChart();
//	});

//Code for updating URL paramaters: window.location('address_goes_here');
</script>


</BODY>
</HTML>