<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>
<HEAD>
</HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>




<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script><script type="application/javascript;version=1.7" src="js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="js/Bugzilla.js"></script>

<script type="application/javascript;version=1.7" src="js/Stats.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>


<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/TeamFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProductFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ClassificationFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/GUI.js"></script>


<link type="text/css" rel="stylesheet" href="css/menu.css"/>

<div id="info"></div>

<div id="pending" style="align:left;"></div>

<div id="complete"></div>

<div id="open"></div>
<!--<div id="info"></div>-->
<!--<table><tr><td style="padding-left:40px;vertical-align: top;width:200px">-->
	<!--<div id="open" style="align:left;display:inline;width:200px"></div>-->
<!--</td><td style="padding-left:40px;vertical-align: top">-->
	<!--<span id="pending" style="align:left;display:inline;"></span>-->
<!--</td><td style="padding-left:40px;vertical-align: top">-->
	<!--<span id="complete" style="align:left;display:inline;"></span>-->
<!--</td></tr></table>-->

<script type="application/javascript;version=1.7">

	var query = {
		"query": {
			"filtered" : {
				"query": {
					"match_all" : {}
				},
				"filter": {
					"and":[
						{ "range" : { "expires_on" : { "gt" : Date.now().addDay(1) } } },
						{ "term" : {"cf_blocking_basecamp": "+"}},
						{"not" : { "terms" : {"bug_status" : ["resolved", "verified", "closed"]}}}
					]
				}
			}
		},
		"from":0,
		"size":0,
		"sort":[
			{ "bug_version_num" : {"sort" : "asc"} }
		],

		"facets" : {
			"pending": {
				"terms": {
					"script_field":
							new MVEL().code({
								"select" : [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"modified_ts", "value":"bugs.modified_ts"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								],
								"from":
										"bugs.attachments.flags",
								"where":
								{"and" : [
									{"terms" : {"bugs.attachments.flags.request_status" : ["?"]}},
									{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
									{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}}
								]}
							}),
					"size": 100000
				}
			},
			"assigned": {
				"terms": {
					"script_field":
							new MVEL().code({
								"select" : [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"assigned_to", "value":"bugs.assigned_to"}
								],
								"from":
										"bugs"
							}),
					"size": 100000
				}
			},
			"reviewed": {
				"terms": {
					"script_field":
							new MVEL().code({
								"select" : [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"modified_ts", "value":"bugs.modified_ts"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								],
								"from":
										"bugs.attachments.flags",
								"where":
								{"and" : [
									{"terms" : {"bugs.attachments.flags.request_status" : ["+"]}},
									{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
									{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}}
								]}
							}),
					"size": 100000
				}
			}



		}
	};

	D.println(query.facets.assigned.terms.script_field);


	ElasticSearchQuery.Run({
		"query":query,


		success: function(data){
			aThread.run(function(){
			var esResult = MVEL.esFacet2List(data.facets.pending, [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"modified_ts", "value":"bugs.modified_ts"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								]);

			var pendingReview=(yield (CUBE.calc2List({
				"from":
					esResult,
				"select":[
					{"name":"request_time", "value":"modified_ts", "operation":"minimum"}
				],
				"edges":[
					{"name":"requestee", "value":"requestee"},
					{"name":"bug_id", "value":"bug_id"}
				]
			})));


			var result = (yield (CUBE.calc2List({
				"from":
					//REQUESTEE AND BUG_ID CAN SHOW UP MORE THAN ONCE, CONDENSE
					pendingReview,
				"select":[
					{"name":"numPending", "value":"1", operation:"count", "sort":"descending"},
					{"name":"maxWaitTime", "value":"Math.round(Date.now().subtract(new Date(request_time)).divideBy(Duration.DAY), 1)+\"days\"", "operation":"maximum"},
					{"name":"bugs", "value":"bug_id", operation:"join", "separator":","}
				],
				"edges":[
					{"name":"requestee", "value":"requestee"}
				],
				"sort":[
					"numPending"
				]
			}))).list;

			//ADD LINK TO BUGS
			result=(yield (CUBE.calc2List({
				"from":result,
				"select":[
					{"name":"requestee", "value":"requestee"},
					{"name":"Number Pending", value:"numPending"},
					{"name":"Max Wait Time", "value":"maxWaitTime"},
					{"name":"Bug List", "value":"\"<a href='https://bugzilla.mozilla.org/buglist.cgi?quicksearch=\"+(''+bugs).replaceAll(', ', '%2C')+\"'>\"+bugs+\"</a>\""}
				]
			}))).list;





			var esResult3 = MVEL.esFacet2List(data.facets.reviewed, [
				{"name":"bug_id", "value":"bugs.bug_id"},
				{"name":"modified_ts", "value":"bugs.modified_ts"},
				{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
			]);

			var doneReview=(yield (CUBE.calc2List({
				"from":
					esResult3,
				"select":[
					{"name":"wait_time", "value":"Math.round(Date.now().subtract(new Date(modified_ts)).divideBy(Duration.DAY), 1)+\"days\"", "operation":"minimum"}
				],
				"edges":[
					{"name":"bug_id", "value":"bug_id"}
				]
			})));

			//FILTER OUT review?
			doneReview=doneReview.list.map(function(v, i){
				for(var p=0;p<pendingReview.list.length;p++){
					if (pendingReview.list[p].bug_id==v.bug_id) return undefined;
				}//for
				return v;
			});


			//ADD LINK TO BUGS
			var result3=(yield (CUBE.calc2List({
				"from":doneReview,
				"select":[
					{"name":"Wait Time", value:"wait_time"},
					{"name":"Bug", "value":"\"<a href='https://bugzilla.mozilla.org/show_bug.cgi?id=\"+bug_id+\"'>\"+bug_id+\"</a>\""}
				]
			}))).list;

















			var assigned = MVEL.esFacet2List(data.facets.assigned, [{"name":"bug_id"},{"name":"assigned_to"}]);
			
			var result2 = (yield (CUBE.calc2List({
				"from":
					assigned,
				"select":[
					{"name":"numPending", "value":"1", operation:"count", "sort":"descending"},
					{"name":"bugs", "value":"bug_id", operation:"join", "separator":","}
				],
				"edges":[
					{"name":"assigned_to", "value":"assigned_to"}
				],
				"sort":[
					"numPending"
				]
			}))).list;

						//ADD LINK TO BUGS
			result2=(yield (CUBE.calc2List({
				"from":result2,
				"select":[
					{"name":"assigned_to", value:"assigned_to"},
					{"name":"numPending", value:"numPending"},
					{"name":"bugs", "value":"\"<a href='https://bugzilla.mozilla.org/buglist.cgi?quicksearch=\"+(''+bugs).replaceAll(', ', '%2C')+\"'>\"+bugs+\"</a>\""}
				]
			}))).list;

			$("#pending").html("<h2>Pending Review (R?)</h2>" + CNV.List2HTMLTable(result));
			$("#complete").html("<h2>Review Completed (R+)</h2>" + CNV.List2HTMLTable(result3));
			$("#open").html("<h2>Assigned To</h2>" + CNV.List2HTMLTable(result2));

		});},

		error: function (errorData, errorMsg, errorThrown){
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}
	});

</script>

</BODY>
</HTML>