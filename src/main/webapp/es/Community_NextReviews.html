<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
</HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>

<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>








<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>



<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script><script type="application/javascript;version=1.7" src="js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="js/Bugzilla.js"></script>

<script type="application/javascript;version=1.7" src="js/Stats.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>






<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/TeamFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProductFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ClassificationFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/GUI.js"></script>

<script type="application/javascript;version=1.7" src="js/etl/ETL.js"></script>
<script type="application/javascript;version=1.7" src="js/etl/Reviews.js"></script>

<h3 id="title">Community First Outgoing Reviews</h3>

<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div id="chart" style="position:relative;"></div>

<div id="info"></div>
<div id="report"></div>


<script type="application/javascript;version=1.7">


var CUTOFF=Duration.newInstance("3week");
$("#description").html("Given the number of outgoing reviews from BZ members, what is the chance another review will be requested in the given window?  All values shown are percentages.  For each BZ email, only the first outgoing review per bug is considered."+
"<br><span class='warning'>Please note this chart is in an early stage: I have not looked into if underlying date is polluted, or if this is a useful measure.</span>"
);

var thread;
var createChart=function(){
	if (thread!==undefined)
		thread.kill();
	thread=aThread.run( __createChart());
};

var __createChart = function(){

	var sampleMin=Date.newInstance(GUI.state.sampleMin);
	var sampleMax=Date.newInstance(GUI.state.sampleMax).ceilingDay();
	var windowSize=Duration.newInstance(GUI.state.window);
	var maxRequest=20;

	var sampleSize=sampleMax.subtract(sampleMin);
	$("#title").html("Community First Outgoing Reviews ("+sampleSize.toString()+" sample)");

	var mainFilter={"and":[
		{"range":{"request_time":{"gte":sampleMin.getMilli(), "lt":sampleMax.add(windowSize).getMilli()}}},
		{"range":{"requester_review_num":{"gte":0, "lte":maxRequest+1}}}	//ONLY ONE REVIEW PER BUG IS CONSIDERED
	]};
	GUI.injectFilters({"esQuery":{"filter":mainFilter, "query":{}}});


	var a=D.action("Download Times");
	var requestTimes=yield(ESQuery.run({
		"from":"reviews",
		"select":[
			{"value":"requester_review_num"},
			{"value":"request_time"},
			{"value":"requester"}
		],
		"esfilter":mainFilter
	}));
	D.actionDone(a, true);

	var markup = yield(CUBE.calc2List({
		"from":requestTimes,
		"analytic":[
			{"name":"time_to_next", "value":"rows[rownum+1]===undefined ? null : rows[rownum+1].request_time-request_time", "sort":"request_time", "edges":["requester"]}
		]
	}));


	var totals=yield (CUBE.calc2Cube({
		"from":markup,
		"select":[
			{"name":"num_next", "value":"(time_to_next!=null && time_to_next<"+windowSize.milli+") ? 1 : 0", "operation":"sum"},
			{"name":"num_total", "value":"1", "operation":"count"}
		],
		"edges":[
			{"name":"requester_review_num", "value":"requester_review_num", "domain":{"type":"linear", "min":0, "max":20, "interval":1, "value":"value"}}
		],
		"where":"request_time<"+sampleMax.getMilli()
	}));

	$("#stats").html(
		'<span class="parameter_name"># First Reviews:</span><b>'+totals.cube[1].num_total+'</b><br>'+
		'<span class="parameter_name"># Second < '+Math.round(windowSize.milli/Duration.MILLI_VALUES.day, 0)+' days:</span><b>'+totals.cube[1].num_next+'</b><br>'+
		'<span class="parameter_name">Retention:</span><b>'+Math.round(100*totals.cube[1].num_next/Math.max(1, totals.cube[1].num_total))+'%</b><br>'
	);


	var chart=yield(CUBE.calc2Cube({
		"from":totals, 
		"select": {"name":"percent", "value":"Math.round(100*num_next/Math.max(1, num_total))", "operation":"one"},
		"edges":[
			{"value":"requester_review_num", "domain":{"type":"linear", "min":0, "max":20, "interval":1, "value":"value"}}
		]
	}));

//	durations.edges[1].domain.NULL.name="Over "+GUI.state.maxX;

	var a=D.action("Make chart", true);
	aChart.show({
		"id":"chart",
		"sheetDiv":"info",
		"type":"bar",
		"stacked":true,
		"cube":chart,
		"height":500,
		showValues: true
	});
	D.actionDone(a);


};





	$(document).ready(function(){
		GUI.setup([
			{"id":"sampleMin", "name":"Start Date", "type":"time", "default":new Date(2012, 1, 1)},
			{"id":"sampleMax", "name":"End Date", "type":"time", "default":new Date(2012, 1, 1).add(Duration.newInstance("18week-day"))},
			{"id":"window", "name":"Window Size", "type":"duration", "default":Duration.newInstance("13week")}
		],
		[
		],
		"reviews");
	});

</script>


</BODY>
</HTML>

