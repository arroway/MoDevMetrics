<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript;version=1.7" src="js/aScript.js"></script>
</HEAD>
<BODY>


<link type="text/css" rel="stylesheet" href="lib/webdetails/lib/tipsy.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>
<link type="text/css" rel="stylesheet" href="css/start/jquery-ui-1.8.16.custom.css" />

<link type="text/css" rel="stylesheet" href="css/menu.css"/>


<a href="http://people.mozilla.com/~klahnakoski/" class="tabzilla">HOME</a>


<div id="sidebar" style="width:400px">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>


<div style="align:left;position:relative;float:left;width:800px;">
	<h3>Telemetry Heat Grid</h3>


	<div class="chart" style="height:600px;width:600px;position: relative;">
		<div id="chartHeat" style="position: absolute;top:0px;left:0px;"></div>
		<div id="chartLine" style="position: absolute;top:0px;left:0px;"></div>
	</div>
	<div id="info"></div>
	<div id="report"></div>
</div>

<script type="application/javascript;version=1.7">


importScript('js/main.js', function(){

//SOMETHING IS CHANGING THE position=relative
var fixer=aThread.run("Monitor regression div", function(){

	while(true){
		$("#chartLine").css("position","absolute");
		yield (aThread.sleep(1000));
	}//while
});
aThread.isRunning.remove(fixer);		//STEALTH MODE


ElasticSearch.baseURL="http://klahnakoski-es.corp.tor1.mozilla.com:9200";

var CUTOFF=Duration.newInstance("3week");
$("#description").html(
		"Simple heat grid to compare the various simple measures.  Least-squares regression line added to get sense of relationship."+
		"We still need to add a the regression distribution, and a plethora of filters"+
		'<br><br><span class="warning">This page points to my server behind the firewall.  You must have Toronto VPN access (vpn.tor1.mozilla.com).</span>'+
		'<br><br><span class="warning">Limited to nighly, WINNT, and all zero-values removed</span>'
);

var thread;

var createChart=function(){
	if (thread!==undefined) thread.kill();
	thread=aThread.run( __createChart());
};

var __createChart = function(){

//	var sampleMin=Date.newInstance(GUI.state.sampleMin);
//	var sampleMax=Date.newInstance(GUI.state.sampleMax).ceilingDay();
//	var sampleInterval=Duration.newInstance(GUI.state.sampleInterval);

	var numParts=CNV.String2Integer(GUI.state.numParts);

	var measureY=GUI.state.measureY;
	var maxY=CNV.String2Integer(GUI.state.maxY);

	var measureX=GUI.state.measureX;
	var maxX=CNV.String2Integer(GUI.state.maxX);

//	var idTime=GUI.state.programFilter.bugStatusMinimum_fromSource();
//	var testValue=GUI.state.programFilter.bugStatusMinimum_fromDoc();
	
	
//	var closeTime="minimum("+sampleMax.getMilli()+", coalesce(zero2null(close_time), "+sampleMax.getMilli()+"))";

//	var mainFilter={"and":[
//			{"and":[
//				{"range":{"modified_ts":{"lt":sampleMax.getMilli()}}},
//				{"range":{"expires_on":{"gte":sampleMin.getMilli()}}}
//			]},
//			{"script":{"script":MVEL.compile.expression("floorInterval(modified_ts-"+sampleMin.getMilli()+", "+sampleInterval.milli+")!=floorInterval(expires_on-"+sampleMin.getMilli()+", "+sampleInterval.milli+")", {"from":"bugs"})}},
//			Mozilla.BugStatus.Open.esfilter,
//			GUI.getFilters("bugs")
//		]};


	//CHART PRODUCT BREAKDOWN
	aThread.run("pull raw telemetry data", function(){
		var response=yield (ESQuery.run({
			"name":measureY+"(Y) vs "+measureX+"(X)",
			"from":"raw_telemetry",
			"select":{"name":"count", "value":"_id", "operation":"count"},
			"edges":[
				{"name":measureY,
					"value":measureY,
					"allowNulls":false,
					"domain":{"type":"linear", "min":"0", "max":maxY, "interval":maxY/numParts, "value":"min"}},
				{"name":measureX,
					"value":measureX,
					"allowNulls":false,
					"domain":{"type":"linear", "min":"0", "max":maxX, "interval":maxX/numParts, "value":"min"}
				}
			],
			"esfilter":{"and":[
				{"term":{"appUpdateChannel":"nightly"}},
				{"term":{"OS":"WINNT"}},
				{"range":Map.newInstance(measureY, {"gt":0})},
				{"range":Map.newInstance(measureX, {"gt":0})}
//				{"exists":{"field":"simpleMeasurements.addonManager"}},
//				{"script":{"script":MVEL.compile.addFunctions('getDocValue("AMI_startup_begin") != null', {"from":"raw_telemetry"})}}
			]}
		}));





		aChart.show({
			"id":"chartHeat",
			"type":"heat",
			"cube":response,
			"titlePaddings":5,
			"height":600,
			"width":600,
//			"baseAxisVisible":false,
			yAxisSize: 50,
			xAxisSize: 50,
			"colorNormByCategory": false,
			"colors":["#EEEEEE", "#BBBBBB", "#999999", "#666666", "#333333"]
		});



		var regressionLine=Stats.query2regression(response);

		aChart.show({
			"id":"chartLine",
			"type":"line",
			"cube":regressionLine,
			"titlePaddings":5,
			"height":550,
			"width":550,
//			"baseAxisSize":50,
			"baseAxisVisible":false,
			"orthoAxisVisible":false,
			"orthoAxisDomainRoundMode" : 'none',
			"orthoAxisFixedMax":response.edges[0].domain.max
//			yAxisSize: 50,
//			xAxisSize: 50,
//			"colorNormByCategory": false,
//			"colors":["#EEEEEE", "#BBBBBB", "#999999", "#666666", "#333333"]
		});



		yield (null);

	});


	yield (null);
};




//file:///C:/Users/klahnakoski/git/Bugzilla%20Anthropology/src/main/webapp/es/Age_OpenBugs.html#sampleInterval=day&sampleMax=2013-01-18&sampleMin=2013-01-15&selectedPrograms=Security+%28High+and+Critical+Only%29&selectedProducts=core,firefox,thunderbird,toolkit,mailnews+core
	$(document).ready(function(){
		GUI.setup(
			createChart,
			[
				{"id":"measureX", "name":"Measure X", "type":"string", "default":"simpleMeasurements.start"},
				{"id":"maxX", "name":"Max X", "type":"number", "default":"100"},
				{"id":"measureY", "name":"Measure Y", "type":"string", "default":"simpleMeasurements.firstPaint"},
				{"id":"maxY", "name":"Max Y", "type":"number", "default":"5000"},
				{"id":"numParts", "name":"Num Parts", "type":"number", "default":"20"}
//				{"id":"sampleMin", "name":"Start Date", "type":"time", "default":Date.eod().add("-18week")},
//				{"id":"sampleMax", "name":"End Date", "type":"time", "default":Date.today()},
//				{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":"week"},
//				{"id":"teamFilter", "name":"Team", "type":TeamFilter.newInstance("assigned_to")}
			],
			[
//				"sampleMax=GUI.fixEndDate(Date.newInstance(sampleMin), Date.newInstance(sampleMax), Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')"
			],
			"raw_telemetry",
			false
		);
	});
});

</script>


</BODY>
</HTML>

