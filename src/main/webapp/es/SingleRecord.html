<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>
<HEAD>
</HEAD>
<BODY>

<script type="application/javascript;version=1.7" src="lib/js/jquery-1.7.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>

<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearchQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script>
<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/aDate.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>

<script type="application/javascript;version=1.7" src="js/Trampoline.js"></script><script type="application/javascript;version=1.7" src="js/CUBE.js"></script>



<div id="info"></div>

<script type="application/javascript;version=1.7">
	D.println(new Date(1352207434236).format("yyyy-NNN-dd HHmmss"));

	var esQuery = {"query":{"filtered":{"query":{"match_all":{}},"filter":{"and":[
		{"script":{"script":"true"}},
		{"range":{"bug_id":{"gte":497056,"lt":497057}}}
	]}}},"from":0,"size":100,"sort":[],"facets":{"mvel":{"terms":{"script_field":
		"var replaceAll = function(output, find, replace){\n"+
		"if (output.length()==0) return output;\n"+
		"s = output.indexOf(find, 0);\n"+
		"while(s>=0){\n"+
		"output=output.replace(find, replace);\n"+
		"s=s-find.length+replace.length;\n"+
		"s = output.indexOf(find, s);\n"+
		"}\n"+
		"output;\n"+
		"};\n"+
		"var Value2Pipe = function(value){\n"+
		"if (value==null){ \"0\" }else if (!(value is String)){ 'n'+value; }else{\n"+
		"\"s\"+replaceAll(replaceAll(value, \"\\\\\", \"\\\\\\\\\"), \"|\", \"\\\\p\");}};\n"+
		"var floorDay = function(value){ Math.floor(value/(24*60*60*1000))*(24*60*60*1000);};\n"+
		"var maximum = function(a, b){if (a==null){ b; }else if (b==null){ a; }else if (a>b){ a; }else{ b;}\n};\n"+
		"var cool_func = function(bugs){\n"+
		"output=\"\";\n"+
		"if (bugs.?attachments!=null){ for(bugs1 : bugs.attachments){\n"+
		"if (bugs1.?flags!=null){ for(bugs2 : bugs1.?flags){\n"+
		"if ((!((bugs2.?request_type==null))) && (bugs1.?attach_id==420463) && ((bugs2.?request_type==\"review\") || (bugs2.?request_type==\"superreview\")) && ((!(bugs2.?request_status==\"?\")) || ((bugs1[\"attachments.isobsolete\"]==1) && (!((bugs.previous_values==null))) && (bugs.previous_values[\"attachments.isobsolete_values\"]==0)) || (((bugs.bug_status==\"resolved\") || (bugs.bug_status==\"verified\") || (bugs.bug_status==\"closed\")) && (!((bugs.previous_values==null))) && (!((bugs.previous_values.bug_status_value==null))) && (!((bugs.previous_values.bug_status_value==\"resolved\") || (bugs.previous_values.bug_status_value==\"verified\") || (bugs.previous_values.bug_status_value==\"closed\")))))){if (output!=\"\") output+=\"|\";\n"+
		"output = output+Value2Pipe(bugs.bug_id)\n"+
		"+\"|\"+Value2Pipe(bugs1.?attach_id)\n"+
		"+\"|\"+Value2Pipe(maximum(bugs.modified_ts, null))\n"+
		"+\"|\"+Value2Pipe(bugs2.?requestee)\n"+
		"+\"|\"+Value2Pipe(bugs2.?modified_by)\n"+
		"+\"|\"+Value2Pipe(bugs1[\"attachments.isobsolete\"]==1 ? 'obsolete' : ((bugs.bug_status=='resolved'||bugs.bug_status=='verified'||bugs.bug_status=='closed') ? 'closed':'done'))\n"+
		";\n"+
		"}\n"+
		"\n"+
		"}}\n"+
		"\n"+
		"}}\n"+
		"output;\n"+
		"};\n"+
		"cool_func(_source)\n"+
		""
,"size":100000}}}}


			;


	//	ElasticSearch.get({
//		"URL":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/reviews/_mapping",
//		"success":function(data){
//			D.println(data);
//
//		}
//	});

	ElasticSearch.post({
		"URL":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/_search",
		"query":esQuery,

		success: function(data){
			D.println(CNV.Object2JSON(data));

			var htmlSummary = CNV.ESResult2HTMLSummaries(data);
			var htmlResults = CNV.List2HTMLTable(CNV.ESResult2List(data));

			document.getElementById("info").innerHTML = htmlSummary + "<br><br>" + htmlResults;
		},

		error: function (errorData, errorMsg, errorThrown){
			D.warning(errorData);
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}
	});

	

</script>

</BODY>
</HTML>