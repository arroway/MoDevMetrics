
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>

<HEAD>
</HEAD>
<BODY>

<!--[if lt IE 9]>

<![endif]-->









<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css"/>






<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>




<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script><script type="application/javascript;version=1.7" src="js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="js/Bugzilla.js"></script>

<script type="application/javascript;version=1.7" src="js/Stats.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>


<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/TeamFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProductFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ClassificationFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/GUI.js"></script>


<h3>Give me a name</h3>
<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div id="chart"></div>

<div id="info"></div>
<div id="report"></div>

<script type="application/javascript;version=1.7">

	$("#description").html("Shows the number of reviews the reviewer was reviewing for each interval.  This can include new reviews, or reviews untouched since the previous interval.");

	var createChart=function(){

		var sampleInterval=Duration.newInstance(GUI.state.sampleInterval);
		var sampleMin=Date.newInstance(GUI.state.sampleMin);
		var sampleMax=sampleMin.add(Date.newInstance(GUI.state.sampleMax).add(sampleInterval).subtract(sampleMin, sampleInterval).floor(sampleInterval));


		var esQuery = {
				"query":{"filtered":{
					"query": {
						"match_all" : {}
					},
					"filter" : {
						"and":[

//							{"terms":{"bug_id":[730079]}},//[600556]}},//, 19963, 505741]}},
							{ "nested": {
								"path" : "attachments.flags",
								"query": {
									"filtered" : {
										"query" : {
											"match_all" : {}
										},
										"filter" : {
											"and":[
												{"terms" : {"attachments.flags.request_type" : ["review", "superreview"]}}
											]
										}
									}
								}
							}}
						]
					}
				}},
				"from" : 0,
				"size" : 10,
				"sort" : [],
				"facets":{
					"inReview": {
						"terms":{
							"script_field":
								new MVEL().code({
									"select" : [
										{"name":"bug_id", "value":"bugs.bug_id"},
										{"name":"attach_id", "value":"bugs.attachments.attach_id"},
										{"name":"modified_ts", "value":"bugs.modified_ts"},
										{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
									],
									"from":
											"bugs.attachments.flags",
									"where":
									{"and" : [
//										{"term":{"bugs.attachments.attach_id":"614487"}},
										{"terms" : {"bugs.attachments.flags.request_status" : ["?"]}},
										{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
										{"term" : {"bugs.attachments.flags.requestee" : GUI.state.requestee}},
										{"script" :{"script":"bugs.attachments.flags.modified_ts==bugs.modified_ts"}},
										{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}}
									]}
								}),
							"size": GUI.state.esSize,
							"sort" : "term"
						},
						"facet_filter":{//HOPEFULLY THIS HELPS
							"and":[
								{"range":{"modified_ts":{"lt":sampleMax.getMilli()}}}
							]
						}
					}
				}
			};


		(GUI.injectFilters({"esQuery":esQuery}));

		console.info(CNV.Object2JSON(esQuery));

		D.action("Call ES");


//		ElasticSearchQuery.Use(
//			{"took":7,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":49,"max_score":1.0,"hits":[{"_index":"bugs20120924","_type":"bug_version","_id":"600556.1310131736000","_score":1.0}]},
//				"facets":{"inReview":{"_type":"terms","missing":0,"total":49,"other":0,"terms":[{"term":"[]","count":39},{"term":"[{\"bug_id\":600556,\"attach_id\":\"556069\",\"modified_ts\":1314355034000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"549597\",\"modified_ts\":1312031372000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"548443\",\"modified_ts\":1311664952000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"546748\",\"modified_ts\":1311049236000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"546388\",\"modified_ts\":1310853211000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"546387\",\"modified_ts\":1310852991000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"545580\",\"modified_ts\":1310501632000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"545579\",\"modified_ts\":1310501569000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"544892\",\"modified_ts\":1310131838000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":600556,\"attach_id\":\"544891\",\"modified_ts\":1310131736000,\"requestee\":\"joe@drew.ca\"}]","count":1}]}}}
//			,
		ElasticSearchQuery.Run({
			"query":esQuery,
			"success" : function(data){
//D.println(CNV.List2Tab(data.facets.inReview));
D.println(CNV.Object2JSON(data));
				var inReview = MVEL.esFacet2List(data.facets.inReview, [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"attach_id", "value":"bugs.attachments.attach_id"},
									{"name":"modified_ts", "value":"bugs.modified_ts"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								]);

				var bugList=CUBE.calc2Cube({
					"from":inReview,
					"select":{"name":"bug_id", "value":"bug_id", "operation":"one"},
					"edges":[{"name":"uid", "value":"bug_id"}]
				}).cube;


				var esQuery2 = {
						"query":{"filtered":{
							"query": {
								"match_all" : {}
							},
							"filter" : {
								"and":[
//										{"terms":{"bug_id":[730079]}},
									{"terms":{"bug_id":bugList}},//, 19963, 505741]}},
									{ "nested": {
										"path" : "attachments.flags",
										"query": {
											"filtered" : {
												"query" : {
													"match_all" : {}
												},
												"filter" : {
													"and":[
														{"terms" : {"attachments.flags.request_type" : ["review", "superreview"]}}
													]
												}
											}
										}
									}}
								]
							}
						}},
						"from" : 0,
						"size" : 10,
						"sort" : [],
						"facets":{
							"doneReview" : {
								"terms":{
									"script_field":
										new MVEL().code({
											"select" : [
												{"name":"bug_id", "value":"bugs.bug_id"},
												{"name":"attach_id", "value":"bugs.attachments.attach_id"},
												{"name":"modified_ts", "value":"(bugs.bug_status=='resolved'||bugs.bug_status=='verified'||bugs.bug_status=='closed') ? bugs.modified_ts : bugs.attachments.flags.modified_ts"},
												{"name":"requestee", "value":"bugs.attachments.flags.requestee==null ? bugs.attachments.modified_by : bugs.attachments.flags.requestee"}
											],
											"from":
													"bugs.attachments.flags",
											"where":
											{"and" : [
//													{"term":{"bugs.attachments.attach_id":"556069"}},
												{"not":{"missing":{"field":"bugs.attachments.flags.request_type", "existence":true, "null_value":true}}},
												{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
												{"or" : [
													{ "and" : [//IF THE REQUESTEE SWITCHED THE ? FLAG, THEN IT IS DONE
														{"not": {"terms" : {"bugs.attachments.flags.request_status" : ["?"]}}},
														{"or":[
															{"term" : {"bugs.attachments.flags.requestee" : GUI.state.requestee}},
															{"and":[
																{"missing":{"field":"bugs.attachments.flags.requestee", "existence":true, "null_value":true}},
																{"term":{"bugs.attachments.modified_by": GUI.state.requestee}}
															]}
														]}
													]},
													{ "and" : [//IF THE ? WAS SWITCHED TO ANOTHER REQUESTEE, THEN IT IS DONE
														{"term" : {"bugs.attachments.flags.request_status" : "?"}},
														{"not":{"term" : {"bugs.attachments.flags.requestee" : GUI.state.requestee}}}
//												{"term":{"bugs.attachments.modified_by": GUI.state.requestee}} //ANYONE CAN SWITCH
													]},
													{"and":[//IF THE REQUESTEE OBSOLEETED THE ATTACHMENT, IT IS DONE
														{"not":{"missing":{"field":"bugs.previous_values", "existence":true, "null_value":true}}},
														{"term":{"bugs.previous_values[\"attachments.isobsolete_values\"]" : 0}},
														{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 1}}
//												{"term":{"bugs.attachments.modified_by": GUI.state.requestee}}  //ANYONE CAN OBSOLETE
													]},
													{ "and" : [//SOME BUGS ARE CLOSED WITHOUT REMOVING REVIEW
														{"terms" : {"bugs.bug_status" : ["resolved", "verified", "closed"]}},
														{"term" : {"bugs.attachments.flags.requestee" : GUI.state.requestee}}
													]}
												]}
											]}
										}),
									"size": GUI.state.esSize,
									"sort" : "term"
								},
								"facet_filter":{//HOPEFULLY THIS HELPS
									"and":[
										{"range":{"modified_ts":{"lt":sampleMax.getMilli()}}}
									]
								}
							}
						}
					};

				console.info(CNV.Object2JSON(esQuery2));
				D.action("Call ES, again");


				ElasticSearchQuery.Run({
					"query":esQuery2,
					"success":function(data){

//D.println(CNV.List2Tab(data.facets.doneReview));
					D.action("processing Data");
					var doneReview = MVEL.esFacet2List(data.facets.doneReview, [
						{"name":"bug_id", "value":"bugs.bug_id"},
						{"name":"attach_id", "value":"bugs.attachments.attach_id"},
						{"name":"modified_ts", "value":"(bugs.bug_status=='resolved'||bugs.bug_status=='verified'||bugs.bug_status=='closed') ? bugs.modified_ts : bugs.attachments.flags.modified_ts"},
						{"name":"requestee", "value":"bugs.attachments.flags.requestee==null ? bugs.attachments.modified_by : bugs.attachments.flags.requestee"}
					]);

D.println(CNV.Object2JSON(data));
//D.println(CNV.List2Tab(inReview));
//D.println(CNV.List2Tab(doneReview));


					var flooring=GUI.state.sampleInterval;
					if (flooring.indexOf("hour")!=-1) flooring="hour";
					if (flooring.indexOf("day")!=-1) flooring="day";
					if (flooring.indexOf("week")!=-1) flooring="week";
					if (flooring.indexOf("month")!=-1) flooring="month";
					if (flooring.indexOf("year")!=-1) flooring="year";



					var reviewQueues = (yield (CUBE.calc2List({
						"from":
							inReview,
						"select":[
//							{"name":"close_record", "sort":["doneReview.end_time", ""]},
							{"name":"end_time", "value":"new Date(Util.coalesce(doneReview.modified_ts, Date.now().getMilli()))", "operation":"minimum"}
						],
						"edges":[
							{"name":"bug_id", "value":"bug_id"},
							{"name":"attach_id", "value":"attach_id"},
							{"name":"requestee", "value":"requestee"},
							{"name":"start_time", "value":"new Date(modified_ts)"},
							{"name":"close_record",
								"test":"bug_id==doneReview.bug_id && attach_id==doneReview.attach_id && requestee==doneReview.requestee && modified_ts<=doneReview.modified_ts",
								allowNulls:true,
								"domain":{"type":"set", "name":"doneReview", "key":[], "partitions":doneReview}
							}
						]//,
//							"where":sampleMin.getMilli()+"<=end_time.getMilli() && start_time.getMilli()<"+sampleMax.getMilli()
					}))).list;



D.println(CNV.List2Tab(reviewQueues));

					var chart=CUBE.calc2Cube({
						"name":
							"Historical Review Queue for "+GUI.state.requestee,
						"from":reviewQueues,
						"select":{"name":"Pending", "value":"1", operation:"sum"},
						"edges":[
							{"name":"Bug ID", "value":"bug_id", "sort":["start_time.floor('"+flooring+"')", "end_time.floor('"+flooring+"')"]},
							{"name":"Date",
								"test":"start_time.floor('"+flooring+"')<=time.value && time.value<=end_time.floor('"+flooring+"')",
								"domain":{"type":"time", "min":GUI.state.sampleMin, "max":sampleMax, "interval":flooring, "format":"NNN dd"}
							}
						],
						"where":new Date(GUI.state.sampleMin).getMilli()+"<=end_time.getMilli() && start_time.getMilli()<"+sampleMax.getMilli()
//							"sort":["Date"]
					});



					aChart.show({
						"id":"chart",
						"type":"stacked",
						"cube":chart
					});

					D.action("Done");


					}//method
				});
			}
		});
	};//createChart


	$(document).ready(function(){
		GUI.setup([
			{"id":"requestee", "name":"Reviewer Email", "type":"text", "default":"nobody@mozilla.com"},
			{"id":"sampleMin", "name":"Sample From", "type":"time", "default":Date.today().add("-14day")},
			{"id":"sampleMax", "name":"Sample To", "type":"time", "default":Date.today()},
			{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":Duration.DAY},
			{"id":"esSize", "name":"ES sample limit", "type":"integer", "default":100000}
		],
		[
			"sampleMax=GUI.fixEndDate(new Date(sampleMin), new Date(sampleMax), Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')"
		]);
	});


</script>


</BODY>
</HTML>