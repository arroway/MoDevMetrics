<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
<script type="application/javascript;version=1.7" src="js/Settings.js">
</script></HEAD>
<BODY>

<!--[if lt IE 9]>

<![endif]-->









<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css"/>






<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/lib/tipsy.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" rel="stylesheet" href="css/start/jquery-ui-1.8.16.custom.css" />
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>




<script type="application/javascript;version=1.7" src="js/aUtil.js"></script><script type="application/javascript;version=1.7" src="js/aArray.js"></script><script type="application/javascript;version=1.7" src="js/aString.js"></script><script type="application/javascript;version=1.7" src="js/aMath.js"></script><script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/aUtil.js"></script><script type="application/javascript;version=1.7" src="js/aArray.js"></script><script type="application/javascript;version=1.7" src="js/aString.js"></script><script type="application/javascript;version=1.7" src="js/aMath.js"></script><script type="application/javascript;version=1.7" src="js/aDate.js"></script><script type="application/javascript;version=1.7" src="js/aDuration.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script><script type="application/javascript;version=1.7" src="js/MozillaDimensions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/BugzillaClient.js"></script><script type="application/javascript;version=1.7" src="js/Bugzilla.js"></script>

<script type="application/javascript;version=1.7" src="js/Stats.js"></script>
<script type="application/javascript;version=1.7" src="js/aDebug.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script><script type="application/javascript;version=1.7" src="js/Hierarchy.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>


<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/TeamFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/ProductFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/GUI.js"></script>

<table style="width: 100%;">
	<tr>
		<td style="width: 320px;">
			    <div style="height: 30px; text-align: center;vertical-align:middle;"><span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span></div>

			<hr>
			<div id="testMessage"></div>
			<hr>
			<div id="parameters" class="parameters">
			</div>
			<div id="filters" class="menu"></div>
		</td>
		<td>
			<div style="float:right;display: inline;"><a href="http://people.mozilla.com/~klahnakoski/">HOME</a></div><div id="chart" style="position:relative;"></div>
		</td>
	</tr>
</table>
<div id="info"></div>
<div id="description"></div>
<div id="report"></div>

<script type="application/javascript;version=1.7">

	var createChart=function(){
		var esQuery = {
				"query":{"filtered":{
					"query": {
						"match_all" : {}
					},
					"filter" : {
						"and":[
							{"range":{"modified_ts":{"gte":Date.newInstance(GUI.state.sampleMin).getMilli()}}},
							{"range":{"modified_ts":{"lt":Date.newInstance(GUI.state.sampleMax).getMilli()}}}
						]
					}
				}},
				"from" : 0,
				"size" : 10,
				"sort" : [],
				"facets":{
					"inReview": {
						"terms":{
							"script_field":
								new MVEL().code({
									"select" : [
										{"name":"bug_id", "value":"bugs.bug_id"},
										{"name":"modified_ts", "value":"bugs.modified_ts"},
										{"name":"requestee", "value":"bugs.attachments.flags.requestee"},
										{"name":"attach_id","value":"bugs.attachments.attach_id"}
									],
									"from":
											"bugs.attachments.flags",
									"where":
									{"and" : [
										{"terms" : {"bugs.attachments.flags.request_status" : ["?"]}},
										{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
//										{"term" : {"bugs.attachments.flags.requestee" : "roc@ocallahan.org"}},
										{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}},
										{"script":{"script":"bugs.attachments.flags.modified_ts==bugs.modified_ts"}}
									]}
								}),
							"size": GUI.state.esSize
						}
					},
					"doneReview" : {
						"terms":{
							"script_field":
									new MVEL().code({
										"select" : [
											{"name":"bug_id", "value":"bugs.bug_id"},
											{"name":"modified_ts", "value":"bugs.modified_ts"},
											{"name":"requestee", "value":"bugs.attachments.flags.requestee"},
											{"name":"attach_id","value":"bugs.attachments.attach_id"}
										],
										"from":
												"bugs.attachments.flags",
										"where":
										{"and" : [
											{"or" : [
												{ "and" : [
													{"not": {"terms" : {"bugs.attachments.flags.request_status" : ["?"]}}},
													{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}}
												]}
											]},
											{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}}
										]}
									}),
							"size": GUI.state.esSize
						}
					}
				}
			};


		(GUI.injectFilters({"esQuery":esQuery}));


		D.action("Call ES");
		ElasticSearchQuery.OldRun(
			{
				"success" : function(data){
					D.action("processing Data");
					var inReview = MVEL.esFacet2List(data.facets.inReview);
					var doneReview = MVEL.esFacet2List(data.facets.doneReview);

					var durations = (yield (CUBE.calc2List({
						"from":
							inReview,
						"select":[
							{"name":"reviewTime", "value":"c.modified_ts-modified_ts", "operation":"minimum"}
						],
						"edges":[
							{"name":"bug_id",
								"test":"bug_id==c.bug_id && requestee==c.requestee && attach_id==c.attach_id && modified_ts<c.modified_ts",
								"domain":{"type":"set", "name":"c", "key":[], "partitions":doneReview}},
							{"name":"finished_time", "value":"modified_ts"},
							{"name":"requestee", "value":"requestee"}
						]
					}))).list;

					var time2res = Q({
						"name": "Review Times",
						"from": durations,
						"select": {"name":"Count", "value":"1", "operation":"count"},
						"edges":[
							{"name":"Cohort", "value":"Date.newInstance(finished_time)",
								"domain":{"type":"time", "min":Date.now().add("-2year"), "max":Date.now(), "interval":"6month", format:"NNN yyyy"}},
							{"name":"Review Time",
								"value":"Duration.newInstance(reviewTime)",
								"allowNulls":true,
								"domain":{"type":"duration", "min":GUI.state.minX, "max":GUI.state.maxX, "interval":GUI.state.intervalX}}
						]
					});

					CUBE.normalizeByCohort(time2res);

					aChart.show({
						"id":"chart",
		"sheetDiv":"info",
						"type":"bar",
						"cube":time2res
					});

									}
			},
			0,
			esQuery
		);
	};//createChart


	$(document).ready(function(){
		GUI.setup(createChart, [
			{"id":"minX", "name":"Min X-axis on Chart", "type":"duration", "default":Duration.newInstance("0")},
			{"id":"maxX", "name":"Max X-axis on Chart", "type":"duration", "default":Duration.newInstance("3month")},
			{"id":"intervalX", "name":"X-axis Interval", "type":"duration", "default":Duration.WEEK},
			{"id":"sampleMin", "name":"Sample From", "type":"time", "default":Date.now().floor("month").add("-2year")},
			{"id":"sampleMax", "name":"Sample To", "type":"time", "default":Date.today()},
			{"id":"esSize", "name":"ES sample limit", "type":"integer", "default":100000}
		]);
	});

</script>


</BODY>
</HTML>