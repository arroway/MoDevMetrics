<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>
<HEAD>
</HEAD>
<BODY>



<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>
<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/aDate.js"></script>
<script type="application/javascript;version=1.7" src="js/aColour.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>

<script type="application/javascript;version=1.7" src="js/MVEL.js"></script><script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>

<script type="application/javascript;version=1.7" src="js/Trampoline.js"></script><script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>
<link type="text/css" rel="stylesheet" href="css/menu.css"/>

<div id="info"></div>

<script type="application/javascript;version=1.7">

	document.getElementById("info").innerHTML = "<h4>This will take many seconds to load to load</h4>";

	var query = {
		"query": {
			"filtered" : {
				"query": {
					"match_all" : {}
				},
				"filter": {
					"and":[
//						{"term":{"bug_id":386313}},
						{ "range" : { "expires_on" : { "gt" : Date.now().addDay(1) } } },
						{"not" : {"terms" : {"bug_status" : ["resolved", "verified", "closed"]}}}
					]
				}
			}
		},
		"from":0,
		"size":0,
		"sort":[
			{ "bug_version_num" : {"order" : "asc"} }
		],

		"facets" : {
			"pendingReview": {
				"terms": {
					"script_field":
							new MVEL().code({
								"select" : [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								],
								"from":
										"bugs.attachments.flags",
								"where":
								{"and" : [
									{"or" : [
										{ "and" : [
											{"terms" : {"bugs.attachments.flags.request_status" : ["?"]}},
											{"terms" : {"bugs.attachments.flags.request_type" : ["review", "superreview"]}},
											{"or":[
												{"missing" : {
													"field" : "bugs.attachments.flags.requestee",
													"existence" : true,
													"null_value" : true
												}},
												{"term":{"bugs.attachments.flags.requestee":"nobody@mozilla.org"}}
											]}
										]}
									]},
									{"term":{"bugs.attachments[\"attachments.isobsolete\"]" : 0}}
								]}
							}),
					"size": 100000
				}
			}
		}
	};

//	D.println(query.edges.assigned.terms.script_field);


	ElasticSearchQuery.Run({
		"query":query,


		success: function(data){
			var esResult = MVEL.esFacet2List(data.facets.pendingReview, [
									{"name":"bug_id", "value":"bugs.bug_id"},
									{"name":"requestee", "value":"bugs.attachments.flags.requestee"}
								]);


			
			var result = new CUBE().calc2List({
				"from":
					//REQUESTEE AND BUG_ID CAN SHOW UP MORE THAN ONCE, CONDENSE
					new CUBE().calc2List({
						"from":
							esResult,
						"select":[
						],
						"edges":[
							{"name":"requestee", "value":"requestee"},
							{"name":"bug_id", "value":"bug_id"}
						]
					}).list,
				"select":[
					{"name":"numPending", "value":"1", operation:"count", "sort":"descending"},
					{"name":"bugs", "value":"bug_id", operation:"join", "separator":", "}
				],
				"edges":[
					{"name":"requestee", "value":"requestee"}
				],
				"order":[
					"numPending"
				]
			}).list;


			//ALTER bugs LIST TO INCLUDE LINK
			result=new CUBE().calc2List({
				"from":result,
				"select":[
					{"name":"numPending", value:"numPending"},
					{"name":"bugs", "value":"\"<a href='https://bugzilla.mozilla.org/buglist.cgi?quicksearch=\"+(''+bugs).replaceAll(', ', '%2C')+\"'>\"+bugs+\"</a>\""}
				],
				"where":"requestee=='nobody@mozilla.org' || requestee==null"
			}).list;



			var htmlSummary = "<h2>Reviews Requested, but no Requestee</h2>" + CNV.List2HTMLTable(result);

			D.println(CNV.Object2JSON(data));

			document.getElementById("info").innerHTML = htmlSummary;
		},

		error: function (errorData, errorMsg, errorThrown){
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}
	});

</script>

</BODY>
</HTML>