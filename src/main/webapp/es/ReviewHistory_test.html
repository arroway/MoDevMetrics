<HTML>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HEAD>
</HEAD>
<BODY>

<!--[if lt IE 9]>
<script type="text/javascript" src="lib/jqplot/excanvas.js"></script>
<![endif]-->
<script type="text/javascript" src="lib/jqplot/jquery.js"></script>
<script type="text/javascript" src="lib/jqplot/jquery.jqplot.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.barRenderer.min.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.categoryAxisRenderer.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.pointLabels.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>
<script type="text/javascript" src="lib/jqplot/plugins/jqplot.logAxisRenderer.js"></script>
<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css"/>






<script type="text/javascript" src="lib/webdetails/cdf/Base.js"></script>
<script type="text/javascript" src="lib/webdetails/cdf/jquery.js"></script>
<script type="text/javascript" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="text/javascript" src="lib/webdetails/data/q01-01.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="text/javascript" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="text/javascript" src="lib/webdetails/pvc/pvc.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="text/javascript" src="lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="text/javascript" src="lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="text/javascript" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/mozilla.css"/>


<script type="text/javascript" src="js/rest/RestConfig.js"></script>

<script type="text/javascript" src="js/CNV.js"></script>
<script type="text/javascript" src="js/aDate.js"></script>
<script type="text/javascript" src="js/Test2.js"></script>
<script type="text/javascript" src="js/MozillaPrograms.js"></script>
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="js/Debug.js"></script>
<script type="text/javascript" src="js/MVEL.js"></script>
<script type="text/javascript" src="js/CUBE.js"></script>
<script type="text/javascript" src="js/CUBE.aggregate.js"></script>
<script type="text/javascript" src="js/CUBE.column.js"></script>
<script type="text/javascript" src="js/CUBE.cube.js"></script>
<script type="text/javascript" src="js/CUBE.domain.js"></script>
<script type="text/javascript" src="js/ESQuery.js"></script>
<script type="text/javascript" src="js/charts/aChart.js"></script>


<script type="text/javascript" src="js/charts/HelperFunctions.js"></script>
<script type="text/javascript" src="js/rest/RestQuery.js"></script>
<script type="text/javascript" src="js/charts/Status.js"></script>
<script type="text/javascript" src="js/charts/DataSet.js"></script>
<script type="text/javascript" src="js/charts/RangeCharts.js"></script>
<script type="text/javascript" src="js/charts/RangeIterator.js"></script>
<script type="text/javascript" src="js/charts/DateRangeIterator.js"></script>

<script type="text/javascript" src="js/filters/Filter.js"></script>
<script type="text/javascript" src="js/filters/ComponentFilter.js"></script>
<script type="text/javascript" src="js/filters/ProductFilter.js"></script>
<script type="text/javascript" src="js/filters/ProgramFilter.js"></script>
<script type="text/javascript" src="js/filters/CustomFilters.js"></script>
<script type="text/javascript" src="js/filters/GUIFilters.js"></script>
<h2>BROKEN - It seems short reviews are not showing closed</h2>
<table style="width: 100%;">
	<tr>
		<td style="width: 320px;">
			<div id="status">Chart Loading...</div>
			<hr>
			<div id="testMessage"></div>
			<hr>
			<div id="parameters" class="parameters">
			</div>
			<div id="filters" class="menu"></div>
		</td>
		<td>
			<div style="float:right;display: inline;"><a href="http://people.mozilla.com/~klahnakoski/">HOME</a></div><div id="chart"></div>
		</td>
	</tr>
</table>
<div id="info"></div>
<div id="description"></div>
<div id="report"></div>

<script type="text/javascript">

	var createChart=function(){
		var esQuery = {
				"query":{"filtered":{
					"query": {
						"match_all" : {}
					},
					"filter" : {
						"and":[

							{"terms":{"bug_id":[486918, 507902]}},//, 19963, 505741]}},
							{ "nested": {
								"path" : "attachments.flags",
								"query": {
									"filtered" : {
										"query" : {
											"match_all" : {}
										},
										"filter" : {
											"and":[
												{"terms" : {"attachments.flags.request_type" : ["review", "superreview"]}}
											]
										}
									}
								}
							}}
						]
					}
				}},
				"from" : 0,
				"size" : 10,
				"sort" : [],
				"facets":{
					"inReview": {
						"terms":{
							"script_field":
								new MVEL().code({
									"select" : [
										{"name":"bug_id", "value":"doc.bug_id"},
										{"name":"attach_id", "value":"doc.attachments.attach_id"},
										{"name":"modified_ts", "value":"doc.modified_ts"},
										{"name":"requestee", "value":"doc.attachments.flags.requestee"}
									],
									"from":
											"doc.attachments.flags",
									"where":
									{"and" : [
										{"term":{"doc.attachments.attach_id":"393341"}},
										{"or" : [
											{ "and" : [
												{"terms" : {"doc.attachments.flags.request_status" : ["?"]}},
												{"terms" : {"doc.attachments.flags.request_type" : ["review", "superreview"]}},
												{"term" : {"doc.attachments.flags.requestee" : state.requestee}},
												{"script":{"script":"doc.attachments.flags.modified_ts==doc.modified_ts"}}
											]}
										]},
										{"term":{"doc.attachments[\"attachments.isobsolete\"]" : 0}}
									]}
								}),
							"size": state.esSize
						},
						"facet_filter":{//HOPEFULLY THIS HELPS
							"and":[
								{"range":{"modified_ts":{"lt":new Date(state.sampleMax).getMilli()}}}
							]
						}
					},
					"doneReview" : {
						"terms":{
							"script_field":
								new MVEL().code({
									"select" : [
										{"name":"bug_id", "value":"doc.bug_id"},
										{"name":"attach_id", "value":"doc.attachments.attach_id"},
										{"name":"requestee", "value":"doc.attachments.flags.requestee"},
										{"name":"modified_ts", "value":"(doc.bug_status=='resolved'||doc.bug_status=='verified'||doc.bug_status=='closed') ? doc.modified_ts : doc.attachments.flags.modified_ts"}
									],
									"from":
											"doc.attachments.flags",
									"where":
									{"and" : [
										{"term":{"doc.attachments.attach_id":"393341"}},
										{"terms" : {"doc.attachments.flags.request_type" : ["review", "superreview"]}},
										{"or" : [
											{ "and" : [//IF THE REQUESTEE SWITCHED THE ? FLAG, THEN IT IS DONE
												{"not": {"terms" : {"doc.attachments.flags.request_status" : ["?"]}}},
												{"or":[
													{"term" : {"doc.attachments.flags.requestee" : state.requestee}},
													{"and":[
														{"missing":{"field":"doc.attachments.flags.requestee", "existence":true, "null_value":true}},
														{"term":{"doc.attachments.modified_by": state.requestee}}
													]}
												]}
											]},
											{"and":[//IF THE REQUESTEE OBSOLEETED THE ATTACHMENT, IT IS DONE
												{"term":{"doc.attachments[\"attachments.isobsolete\"]" : 1}},
												{"term":{"doc.attachments.modified_by": state.requestee}}																								
											]},
											{ "and" : [//SOME BUGS ARE CLOSED WITHOUT REMOVING REVIEW
												{"terms" : {"doc.bug_status" : ["resolved", "verified", "closed"]}},
												{"term" : {"doc.attachments.flags.requestee" : state.requestee}}
											]}
										]}
									]}
								}),
							"size": state.esSize
						},
						"facet_filter":{//HOPEFULLY THIS HELPS
							"and":[
								{"range":{"modified_ts":{"lt":new Date(state.sampleMax).getMilli()}}}
							]
						}
					}
				}
			};


		ES.InjectFilter({"esQuery":esQuery});

		console.info(CNV.Object2JSON(esQuery));

		status.message("Call ES");


		RestQuery.Run(
//		RestQuery.Use(
//			{"took":180,"timed_out":false,"_shards":{"total":5,"successful":5,"failed":0},"hits":{"total":148,"max_score":1.0,"hits":[]},"facets":{"inReview":{"_type":"terms","missing":0,"total":148,"other":0,"terms":[{"term":"[]","count":136},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393841\",\"modified_ts\":1249995728000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393734\",\"modified_ts\":1249958017000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393434\",\"modified_ts\":1249808687000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393194\",\"modified_ts\":1249634680000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"392801\",\"modified_ts\":1249483756000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"392470\",\"modified_ts\":1249368856000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"392469\",\"modified_ts\":1249359169000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"392341\",\"modified_ts\":1249311887000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"614487\",\"modified_ts\":1334233003000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609638\",\"modified_ts\":1332806654000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609636\",\"modified_ts\":1332806351000,\"requestee\":\"joe@drew.ca\"}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"607317\",\"modified_ts\":1332166535000,\"requestee\":\"joe@drew.ca\"}]","count":1}]},"doneReview":{"_type":"terms","missing":0,"total":148,"other":0,"terms":[{"term":"[{\"bug_id\":486918,\"attach_id\":\"614487\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1336380205000}]","count":42},{"term":"[]","count":41},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1348569007000}]","count":22},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609636\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1332851471000}, {\"bug_id\":486918,\"attach_id\":\"609868\",\"requestee\":null,\"modified_ts\":1332855662000}]","count":5},{"term":"[{\"bug_id\":486918,\"attach_id\":\"607317\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1332406293000}]","count":3},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393841\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1249999727000}]","count":2},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393194\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1249808803000}]","count":2},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609636\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1332851471000}]","count":2},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393734\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1249997848000}]","count":1},{"term":"[{\"bug_id\":507902,\"attach_id\":\"393734\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1249997848000}, {\"bug_id\":507902,\"attach_id\":\"393841\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1249999727000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1350969356000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1350925633000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1350910698000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1350544784000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1350537854000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349856623000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349577372000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349438664000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349437774000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349437108000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349421777000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349283878000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349266405000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349230966000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349227989000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349213860000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349203034000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349175841000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349103875000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349067570000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349064639000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349064547000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349055298000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1349003436000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"664563\",\"requestee\":null,\"modified_ts\":1348982711000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609868\",\"requestee\":null,\"modified_ts\":1332855662000}]","count":1},{"term":"[{\"bug_id\":486918,\"attach_id\":\"609636\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1332851471000}, {\"bug_id\":486918,\"attach_id\":\"609638\",\"requestee\":\"joe@drew.ca\",\"modified_ts\":1332853963000}]","count":1}]}}}
//			,
			{
				"success" : function(requestObj, data){
					status.message("processing Data");
					var inReview = CNV.ESFacet2List(data.facets.inReview);
					var doneReview = CNV.ESFacet2List(data.facets.doneReview);


D.println(CNV.List2Tab(inReview));
D.println(CNV.List2Tab(doneReview));

					var flooring=state.sampleInterval;
					if (flooring.indexOf("hour")!=-1) flooring="hour";
					if (flooring.indexOf("day")!=-1) flooring="day";
					if (flooring.indexOf("week")!=-1) flooring="week";
					if (flooring.indexOf("month")!=-1) flooring="month";
					if (flooring.indexOf("year")!=-1) flooring="year";

					var reviewQueues = new CUBE().calc2List({
						"from":
							inReview,
						"select":[
							{"name":"bug_id", "value":"bug_id", "operation":"one"},
							{"name":"attach_id", "value":"attach_id", "operation":"one"},
							{"name":"end_time", "value":"new Date(Util.coalesce(doneReview.modified_ts, Date.now().getMilli()))", "operation":"minimum"}
						],
						"edges":[
							{"name":"close_record", "test":"bug_id==doneReview.bug_id && attach_id==doneReview.attach_id && requestee==doneReview.requestee && modified_ts<=doneReview.modified_ts", allowNulls:true,
								"domain":{"type":"set", "name":"doneReview", "key":["bug_id", "attach_id", "modified_ts", "requestee"], "partitions":doneReview}
							},
							{"name":"requestee", "value":"requestee"},
							{"name":"start_time", "value":"new Date(modified_ts)"}
						],
						"where":"modified_ts<"+new Date(state.sampleMax).getMilli()+"  && (doneReview.bug_id==null || doneReview.modified_ts>="+new Date(state.sampleMin).getMilli()+")\n"
					}).list;
D.println(CNV.List2Tab(reviewQueues));

					var chart=new CUBE().calc2Cube({
						"name":
							"Historical Review Queue for "+state.requestee,
						"from":reviewQueues,
						"select":{"name":"Pending", "value":"1", operation:"binary"},
						"edges":[
							{"name":"Bug ID", "value":"bug_id", "order":["start_time.floor('"+flooring+"')", "end_time.floor('"+flooring+"')"]},
							{"name":"Date", "test":"start_time.floor('"+flooring+"')<=time.value && time.value<=end_time.add('"+flooring+"').floor('"+flooring+"')", "domain":{"type":"time", "min":state.sampleMin, "max":state.sampleMax, "interval":flooring, "format":"NNN dd"}}
						]
					});



					aChart.showCCC({
						"id":"chart",
						"type":"stacked",
						"cube":chart
					});

					status.message("Done");
				}
			},
			0,
			esQuery
		);
	};//createChart


	$(document).ready(function(){
		GUI.setup([
			{"id":"requestee", "name":"Reviewer Email", "type":"text", "default":"joe@drew.ca"},
			{"id":"sampleMin", "name":"Sample From", "type":"time", "default":Date.now().floor("day").add("-3month")},
			{"id":"sampleMax", "name":"Sample To (but not including)", "type":"time", "default":Date.now().floor("day")},
			{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":Duration.newInstance("week")},
			{"id":"esSize", "name":"ES sample limit", "type":"integer", "default":100000}
		]);
		createChart();
	});

</script>


</BODY>
</HTML>