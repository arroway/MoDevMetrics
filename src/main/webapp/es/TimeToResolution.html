<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>
<HEAD>
</HEAD>
<BODY>
<!--&lt;!&ndash;[if lt IE 9]>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/excanvas.js"></script>-->
<!--<![endif]&ndash;&gt;-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/jquery.min.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/jquery.jqplot.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.barRenderer.min.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.categoryAxisRenderer.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.pointLabels.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.dateAxisRenderer.min.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.canvasAxisTickRenderer.js"></script>-->
<!--<script type="application/javascript;version=1.7" src="lib/jqplot/plugins/jqplot.logAxisRenderer.js"></script>-->
<!--<link rel="stylesheet" type="text/css" href="lib/jqplot/jquery.jqplot.css"/>-->






<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>

<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>








<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>



<script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="js/util.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script><script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script><script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/Rest.js"></script><script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>






<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/Status.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/filters/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProductFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/ProgramFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/CustomFilters.js"></script>
<script type="application/javascript;version=1.7" src="js/filters/GUIFilters.js"></script>


<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<h3 id="title"></h3>
<div id="chart"></div>

<div id="info"></div>
<div id="report"></div>


<script type="application/javascript;version=1.7">


var CUTOFF=Duration.newInstance("3week");
$("#description").html("<span class='warning'>SLOW (about 30sec)</span> This chart includes all bugs identified since the Start Date.  For closed bugs, the duration is defined from the time the bug is identified, to the time the bug is closed.  For open bugs, the duration is defined from the time the bug is identified, to the end of today (GMT).  These durations are partitioned into intervals, counted, and charted here.  If you just got here, and have not chosen a filter below, THIS WILL TAKE SOME TIME.");

var thread;
var createChart=function(){
	if (thread!==undefined)
		thread.kill();
	thread=aThread.run( __createChart());
};

var __createChart = function(){
	var sampleSize=Date.now().ceilingDay().subtract(new Date(state.sampleMin), Duration.newInstance(state.intervalX));
	$("#title").html("Time to Resolution ("+sampleSize.toString()+" sample)");


	var query=new ESQuery({
		"from":"bugs",
		"select":[
			{"name":"first_identified", "value":"modified_ts", "operation":"minimum"}
		],
		"edges":[
			{"name":"bug_id", "value":"bug_id"}
		],
		"esfilter":{"and":[
			//MAKE SURE WE REPORT BACK FAR ENOUGH IN TIME TO CAPTURE THE LONGEST TIMES (state.maxX) BEING REPORTED
			{"range":{"modified_ts":{"gte":new Date(state.sampleMin).getMilli()}}}
		]}
	});

	var query2=new ESQuery({
		"from":"bugs",
		"select":[
			{"name":"close_time", "value":"modified_ts", "operation":"minimum"}
		],
		"edges":[
			{"name":"bug_id", "value":"bug_id"}
		],
		"esfilter":{"or":[
			{"and":[
				{"range":{"modified_ts":{"gte":new Date(state.sampleMin).getMilli()}}},
				{"terms" : {"bug_status" : ["resolved", "verified", "closed"]}},
				{"term":{"changes.field_name":"bug_status"}},
				{"not":{"terms":{"changes.field_value_removed":["resolved", "verified", "closed"]}}}
			]},
			{"range":{"expires_on":{"gt":Date.now().ceilingDay().getMilli()}}}
		]}
	});

	ES.InjectGUIFilter(query);
	ES.InjectGUIFilter(query2);

	status.message("Download ID Times");
	var identified=yield(query.run());

	status.message("Download Close Times");
	var closed=yield(query2.run());

	status.message("Match Identification with Close");

	identified=yield (CUBE.Cube2List(identified));
	closed=yield (CUBE.Cube2List(closed));

	var durations = (yield (CUBE.calc2List({
		"from":
			identified,
		"select":[
			{"name":"bug_status", "value":"c.bug_id==null ? 'open' : 'closed'", "operation":"minimum"},
			{"name":"duration", "value":"Util.coalesce(c.close_time, "+Date.now().ceilingDay().getMilli()+") - first_identified", "operation":"average"}
		],
		"edges":[
			{"name":"bug_id", "value":"bug_id"},
			{"name":"close", "value":"bug_id", "allowNulls":true, "domain":{"type":"set", "name":"c", "key":"bug_id", "partitions":closed}}
		],
		"where":"Util.coalesce(c.close_time, "+Date.now().ceilingDay().getMilli()+") > first_identified"	//REMOVE UNMATCHED AND ZERO-DURATION
	}))).list;

	var stats = (yield(CUBE.calc2Cube({
		"from": durations,
		"select":[
			{"name":"total", "value":"bug_id", "operation":"count"},
			{"name":"num_open", "value":"bug_status=='open' ? 1 : 0", "operation":"sum"},
			{"name":"num_closed", "value":"bug_status=='closed' ? 1 : 0", "operation":"sum"},
			{"name":"average", "value":"duration", "operation":"average"},
			{"name":"under", "value":"duration<"+CUTOFF.milli+" ? 1 : 0", "operation":"sum"}
		]
	}))).cube;


	$("#stats").html(
		'<span class="parameter_name">Total Bugs:</span><b>'+stats.total+'</b><br>'+
		'<span class="parameter_name">Bugs Closed per week:</span><b>'+Math.round(stats.num_closed/(sampleSize.milli/Duration.MILLI_VALUES.week), 0)+'</b><br>'+
		'<span class="parameter_name">Open Bugs Remaining:</span><b>'+Math.round(stats.num_open, 0)+'</b><br>'+
		'<span class="parameter_name">% Under '+CUTOFF.toString()+'</span><b>'+Math.round(stats.under/stats.total*100, 1)+'%</b><br>'+
		'<span class="parameter_name">Average Time Open:</span><b>'+Math.round(stats.average/Duration.MILLI_VALUES.day, 2)+'days</b><br>'
	);

	status.message("Tally into interval buckets");
	var time2res = yield(CUBE.calc2Cube({
		//"name": "Time to Resolution (Open and Closed Bugs)",
		"from": durations,
		"select": {"name":"Count", "value":"1", "operation":"count"},
		"edges":[
			{"name":"Cohort", "value":"\"Number of bugs\""},
			{"name":"Time Since Marked", "value":"Duration.newInstance(duration)", allowNulls:true,
				"domain":{"type":"duration", "min":state.minX, "max":state.maxX, "interval":state.intervalX, "value":"name+\"+\""}}
		]
	}));

//				CUBE.normalizeByCohort(time2res, 100);
	time2res.edges[1].domain.NULL.name="Over "+state.maxX;

	status.message("Make chart");
	aChart.showCCC({
		"id":"chart",
		"type":"bar",
		"cube":time2res
	});
	status.message("Done");


};





	$(document).ready(function(){
		GUI.setup([
			{"id":"minX", "name":"Min X-axis on Chart", "type":"duration", "default":Duration.newInstance("0")},
			{"id":"maxX", "name":"Max X-axis on Chart", "type":"duration", "default":Duration.newInstance("3month")},
			{"id":"intervalX", "name":"X-axis Interval", "type":"duration", "default":Duration.newInstance("week")},
			{"id":"sampleMin", "name":"Start Date", "type":"time", "default":Date.now().ceilingDay().add("-18week")},
			{"id":"esSize", "name":"ES sample limit", "type":"integer", "default":100000}
		],
		[
			"maxX=Duration.newInstance(maxX).add(Duration.newInstance(intervalX)).add(Duration.newInstance('-second')).floor(Duration.newInstance(intervalX)).toString()"
		]);
	});

</script>


</BODY>
</HTML>