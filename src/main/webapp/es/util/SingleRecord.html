<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
<script type="application/javascript;version=1.7" src="../js/Settings.js">
</script></HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="../lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="../css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="../lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="../lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="../css/menu.css"/>


<script type="application/javascript;version=1.7" src="../js/aUtil.js"></script><script type="application/javascript;version=1.7" src="../js/aArray.js"></script><script type="application/javascript;version=1.7" src="../js/aString.js"></script><script type="application/javascript;version=1.7" src="../js/aMath.js"></script>
<script type="application/javascript;version=1.7" src="../js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDate.js"></script><script type="application/javascript;version=1.7" src="../js/aDuration.js"></script>

<script type="application/javascript;version=1.7" src="../js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDebug.js"></script>
<script type="application/javascript;version=1.7" src="../js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="../js/aCompiler.js"></script>


<script type="application/javascript;version=1.7" src="../js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="../js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/aChart.js"></script>

<script type="application/javascript;version=1.7" src="../js/gui/ProgramFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="../js/etl/ETL.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/Reviews.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/BugSummary.js"></script>

<div id="status"></div>
<div id="info"></div>
<h2>Simple Query</h2>

<div id="chart" style="width:800px;height:400px;"></div>
<div id="chart2" style="width:800px;height:400px;"></div>


<script type="application/javascript;version=1.7">

	aThread.run(function(){

		D.println(Date.newInstance(1352207434236).format("yyyy-NNN-dd HHmmss"));
		yield (ESQuery.loadColumns({"from":"bugs"}));

		var esQuery = { "facets":{ "0":{ "facet_filter":{"and":[
			{"and":[
				{"range":{"request_time":{"lt":1363564800000}}},
				{"script":{"script":"var minimum = function(a, b){if (a==null) b; else if (b==null) a; else if (a<b) a; else b;\n"+
						"};\n"+"var coalesce = function(a, b){if (a==null) b; else a; \n"+
						"};\n"+"var zero2null = function(a){if (a==0) null; else a; \n"+
						"};\n"+"var get = function(hash, key){\n"+"if (hash==null) null; else hash[key];\n"+
						"};\n"+"var getDocValue = function(name){\n"+"var out = [];\n"+
						"var v = doc[name];\n"+
						"if (v==null || v.value==null) { null; } else if (v.values.length<=1){ v.value; } else {for(k : v.values) out.add(k); out;}};\n"+
						"var _1000 = function(reviews){\n"+
						"var review_time = getDocValue(\"review_time\");\n"+
						"var request_time = getDocValue(\"request_time\");\n"+
						"output = (1363564800000 /*13Mar18 000000*/ <= minimum(request_time+10886400000 /*18week*/, coalesce(zero2null(review_time), 1363996800000 /*13Mar23 000000*/)));\n"+
						" output;\n"+
						"};\n"+
						"_1000(_source)\n"+""}}
			]}
		]}, "terms_stats":{ "size":200000, "value_script":
				"var minimum = function(a, b){if (a==null) b; else if (b==null) a; else if (a<b) a; else b;\n"+"};\n"+
						"var zero2null = function(a){if (a==0) null; else a; \n"+"};\n"+
						"var get = function(hash, key){\n"+"if (hash==null) null; else hash[key];\n"+"};\n"+
						"var getDocValue = function(name){\n"+"var out = [];\n"+
						"var v = doc[name];\n"+"if (v==null || v.value==null) { null; } else if (v.values.length<=1){ v.value; } else {for(k : v.values) out.add(k); out;}};\n"+
						"var _1000 = function(reviews){\n"+
						"var review_time = getDocValue(\"review_time\");\n"+
						"var request_time = getDocValue(\"request_time\");\n"+
						"output = minimum(zero2null(review_time), 1363651200000 /*13Mar19 000000*/)-request_time; output;\n"+
						"};\n"+
						"_1000(_source)\n"+"",
			"key_field":"bug_id" } } }, "sort":[], "size":20, "from":0, "query":{"filtered":{ "filter":{"and":[
			{"script":{"script":"true"}},
			{"and":[
				{"range":{"request_time":{"gte":1363564800000,"lt":1363737600000}}},
				{"term":{"is_first":"1"}}
			]}
		]}, "query":{"match_all":{}} }} };
//		{
//			"facets":{"mvel":{"terms":{ "size":200000, "script_field":"doc[\"dependson\"].value"}}},
//			"sort":[], "size":0, "from":0, "query":{"filtered":{ "filter":{"and":[
////			{"term":{"bug_id":180171}}  //BAD
////			{"term":{"bug_id":6625}}	//GOOD
//		]}, "query":{"match_all":{}} }} };


		try{
			var data = yield(Rest.post({
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/bug_version/_mapping?pretty=true",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_summary/bug_summary/_search",

//			"url":"http://localhost:9200/reviews/review/_search",
//			"url":"http://localhost:9200/bug_tags/bug_tags/_search",
			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/reviews/review/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_tags/bug_tags/_search",
//				"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/telemetry/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/org_chart/person/_search",
				"data":esQuery
			}));





			D.println(CNV.Object2JSON(data));

			var htmlSummary = CNV.ESResult2HTMLSummaries(data);
			var htmlResults = CNV.List2HTMLTable(CNV.ESResult2List(data));
			$("#info").html(htmlSummary + "<br><br>" + htmlResults);


//		while(true){
//			if (ETL.allFlags!==undefined) break;
//			yield (aThread.sleep(200));
//		}//while
//		var reviews=yield (REVIEWS.get(674239, 674240));
//		$("#info").append(CNV.List2HTMLTable(reviews));
//


		} catch(e){
			D.warning("Error sending requests", e);
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}

	});

</script>

</BODY>
</HTML>