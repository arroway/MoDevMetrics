<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>
<HEAD>
</HEAD>
<BODY>





<script type="application/javascript;version=1.7" src="../lib/jquery.js"></script>
<link type="text/css" href="../css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="../lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="../lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="../css/menu.css"/>


<script type="application/javascript;version=1.7" src="../js/charts/Status.js"></script>


<script type="application/javascript;version=1.7" src="../js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="../js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="../js/util.js"></script>
<script type="application/javascript;version=1.7" src="../js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="../js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="../js/aCompiler.js"></script>


<script type="application/javascript;version=1.7" src="../js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script><script type="application/javascript;version=1.7" src="../js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/aChart.js"></script>

<script type="application/javascript;version=1.7" src="../js/filters/ProgramFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="../js/etl/ETL.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/Reviews.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/BugSummary.js"></script>

<div id="info"></div>

<script type="application/javascript;version=1.7">

aThread.run(function(){

	D.println(new Date(1352207434236).format("yyyy-NNN-dd HHmmss"));

//	var esQuery = {"query":{"filtered":{"query":{"match_all":{}},"filter":{"and":[
//		{"script":{"script":"true"}},
//		{"and":[
//			{"term":{"bug_id":"814029"}}
//		]}
//	]}}},"from":0,"size":1000,"sort":["bug_version_num"]
//	};


	var esQuery = {"query":{"filtered":{"query":{"match_all":{}},"filter":{"and":[
		{"script":{"script":"true"}},
		{"and":[
			{"script":{"script":"1342742400000 <= doc[\"Security (High and Critical Only)_time\"].value && doc[\"Security (High and Critical Only)_time\"].value < 1353628800000"}}
		]},
//		{"or":[
//			{"prefix":{"status_whiteboard.tokenized":"sg:crit"}},
//			{"prefix":{"status_whiteboard.tokenized":"sg:high"}},
//			{"prefix":{"keywords":"sec-high"}},
//			{"prefix":{"keywords":"sec-critical"}}
//		]},
		{"script":{"script":"true"}},
		{"script":{"script":"true"}}
	]}}},"from":0,"size":100,"sort":[],"facets":{"0":{"terms":{"script_field":"var replaceAll = function(output, find, replace){\nif (output.length()==0) return output;\ns = output.indexOf(find, 0);\nwhile(s>=0){\noutput=output.replace(find, replace);\ns=s-find.length+replace.length;\ns = output.indexOf(find, s);\n}\noutput;\n};\nvar get = function(hash, key){\nif (hash==null) null; else hash[key];\n};\nvar Value2Pipe = function(value){\nif (value==null){ \"0\" }else if (value is ArrayList){ 's'+value.toString(); }else \nif (value is Long || value is Integer){ 'n'+value; }else \nif (!(value is String)){ 's'+value.getClass().getName(); }else \n\"s\"+replaceAll(replaceAll(value, \"\\\\\", \"\\\\\\\\\"), \"|\", \"\\\\p\");};\nvar minimum = function(a, b){if (a==null) b; else if (b==null) a; else if (a<b) a; else b;\n};\nvar coalesce = function(a, b){if (a==null) b; else a; \n};\nvar zero2null = function(a){if (a==0) null; else a; \n};\n''+Value2Pipe(minimum(1353628800000, coalesce(zero2null(doc[\"close_time\"].value), 1353628800000)) < 1353628800000 ? \"Closed\" : \"Open\")+'|'+(((minimum(1353628800000, coalesce(zero2null(doc[\"close_time\"].value), 1353628800000))-doc[\"Security (High and Critical Only)_time\"].value<0) || (minimum(1353628800000, coalesce(zero2null(doc[\"close_time\"].value), 1353628800000))-doc[\"Security (High and Critical Only)_time\"].value>=7257600000)) ? 12 : Math.floor((minimum(1353628800000, coalesce(zero2null(doc[\"close_time\"].value), 1353628800000))-doc[\"Security (High and Critical Only)_time\"].value-0)/604800000))","size":100000}}}};

//	var esQuery = {"query":{"filtered":{"query":{"match_all":{}},"filter":{"and":[
//		{"script":{"script":"true"}},
//		{"range":{"request_time":{"gt":1342483200000}}}
//	]}}},"from":0,"size":0,"sort":[],"facets":{"0":{"terms":{
////		"script_field":"var coalesce = function(a, b){if (a==null) b; else a; \n};\n''+((((coalesce(doc['review_time'], 1353369600000)-doc['request_time'])<0) || ((coalesce(doc['review_time'], 1353369600000)-doc['request_time'])>=864000000)) ? 10 : Math.floor(((coalesce(doc['review_time'], 1353369600000)-doc['request_time'])-0)/86400000))",
//		"script_field":"var coalesce = function(a, b){if (a==null) b; else a; \n};\n''+coalesce(doc[\"review_time\"].value, 1353369600000)",
//			"size":100000}}}};

//	var esQuery = {"query":{"filtered":{"query":{"match_all":{}},"filter":{"and":[
////		{"script":{"script":"true"}},
////		{"range":{"expires_on":{"gt":1353110400000}}},
//		{"range":{"bug_id":{"gte":812400,"lt":812600}}}
//	]}}},"from":0,"size":0,"sort":[],"facets":{"mvel":{"terms":{
//		"script_field":
////			"var coalesce = function(a, b){if (a==null){ b; }else{ a; }\n"+
////			"};\n"+
////			"var get = function(hash, key){\n"+
////				"if (hash==null) null; else {\n"+
////					"hash[key];\n"+
////				"}\n"+
////			"};\n"+
//			"var cool_func = function(bugs){\n"+
////				"output = coalesce(get(bugs.?previous_values, 'product_change_away_ts'), bugs.created_ts);\n"+
////				"output = get(bugs.?previous_values, 'product_change_away_ts');\n"+
//				"output = bugs.?previous_values;\n"+
//				"output;\n"+
//			"};\n"+
//			"cool_func(_source)\n"+
//			""
//			,
//		"size":100000
//	}}}
//	};


	try{
		var data=yield (Rest.post({
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/reviews/review/_search",
			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_summary/bug_summary/_search",
			"data":esQuery
		}));

		D.println(CNV.Object2JSON(data));

		var htmlSummary = CNV.ESResult2HTMLSummaries(data);
		var htmlResults = CNV.List2HTMLTable(CNV.ESResult2List(data));
		document.getElementById("info").innerHTML = htmlSummary + "<br><br>" + htmlResults;

	}catch(e){
		D.warning(errorData);
		document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
	}

});

</script>

</BODY>
</HTML>