<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
<script type="application/javascript;version=1.7" src="../js/Settings.js">
</script></HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="../lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="../css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="../lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="../lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="../css/menu.css"/>


<script type="application/javascript;version=1.7" src="../js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="../js/util.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="../js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="../js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="../js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="../js/aCompiler.js"></script>


<script type="application/javascript;version=1.7" src="../js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="../js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/aChart.js"></script>

<script type="application/javascript;version=1.7" src="../js/gui/ProgramFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="../js/etl/ETL.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/Reviews.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/BugSummary.js"></script>

<div id="status"></div>
<div id="info"></div>
<h2>Simple Query</h2>

<div id="chart" style="width:800px;height:400px;"></div>
<div id="chart2" style="width:800px;height:400px;"></div>


<script type="application/javascript;version=1.7">

	aThread.run(function(){

		D.println(Date.newInstance(1352207434236).format("yyyy-NNN-dd HHmmss"));


		var esQuery = { "facets":{ "reviewed":{"terms":{ "size":100000,
			"script_field":"var get = function(hash, key){\n"+
					"if (hash==null) null; else hash[key];\n};\n"+
					"var Value2Pipe = function(value){\n"+
					"if (value==null){ \"0\" }else if (value is ArrayList){ 's'+value.toString(); }else \nif (value is Long || value is Integer){ 'n'+value; }else \n"+
					"if (!(value is String)){ 's'+value.getClass().getName(); }else \n"+
					"\"s\"+value.replace(\"\\\\\", \"\\\\\\\\\").replace(\"|\", \"\\\\p\");};\n"+
					"var _1000 = function(bugs){\nvar modified_ts = doc[\"modified_ts\"].value;\n"+
					"var bug_id = doc[\"bug_id\"].value;\n"+
					"var assigned_to = doc[\"assigned_to\"].value;\n"+
					"output=\"\";\nif (bugs.attachments!=null){"+
					" for(bugs1 : bugs.attachments){\nif (bugs1.?flags!=null){ for(bugs2 : bugs1.?flags){\nif ((bugs2.?request_status==\"+\") && ((bugs2.?request_type==\"review\") || (bugs2.?request_type==\"superreview\")) && (bugs1[\"attachments.isobsolete\"]==0) && ((assigned_to==\"msreckovic@mozilla.com\") || (assigned_to==\"bgirard@mozilla.com\") || (assigned_to==\"bjacob@mozilla.com\") || (assigned_to==\"bas.schouten@live.nl\") || (assigned_to==\"gwright@mozilla.com\") || (assigned_to==\"joe@drew.ca\") || (assigned_to==\"jmuizelaar@mozilla.com\") || (assigned_to==\"nical.bugzilla@gmail.com\"))){if (output!=\"\") output+=\"|\";\noutput+=Value2Pipe(bugs.bug_id)\n+\"|\"+Value2Pipe(bugs.modified_ts)\n+\"|\"+Value2Pipe(bugs2.?requestee)\n;\n}\n\n}}\n\n}}\noutput;\n};\n_1000(_source)\n" }}, "assigned":{"terms":{ "size":100000, "script_field":"var get = function(hash, key){\nif (hash==null) null; else hash[key];\n};\nvar Value2Pipe = function(value){\nif (value==null){ \"0\" }else if (value is ArrayList){ 's'+value.toString(); }else \nif (value is Long || value is Integer){ 'n'+value; }else \nif (!(value is String)){ 's'+value.getClass().getName(); }else \n\"s\"+value.replace(\"\\\\\", \"\\\\\\\\\").replace(\"|\", \"\\\\p\");};\nvar _1000 = function(bugs){\nvar bug_id = doc[\"bug_id\"].value;\nvar assigned_to = doc[\"assigned_to\"].value;\noutput=\"\";\nif ((assigned_to==\"msreckovic@mozilla.com\") || (assigned_to==\"bgirard@mozilla.com\") || (assigned_to==\"bjacob@mozilla.com\") || (assigned_to==\"bas.schouten@live.nl\") || (assigned_to==\"gwright@mozilla.com\") || (assigned_to==\"joe@drew.ca\") || (assigned_to==\"jmuizelaar@mozilla.com\") || (assigned_to==\"nical.bugzilla@gmail.com\")){output = Value2Pipe(bugs.bug_id)\n+\"|\"+Value2Pipe(bugs.assigned_to)\n;\n}\noutput;\n};\n_1000(_source)\n" }}, "pending":{"terms":{ "size":100000, "script_field":"var get = function(hash, key){\nif (hash==null) null; else hash[key];\n};\nvar Value2Pipe = function(value){\nif (value==null){ \"0\" }else if (value is ArrayList){ 's'+value.toString(); }else \nif (value is Long || value is Integer){ 'n'+value; }else \nif (!(value is String)){ 's'+value.getClass().getName(); }else \n\"s\"+value.replace(\"\\\\\", \"\\\\\\\\\").replace(\"|\", \"\\\\p\");};\nvar _1000 = function(bugs){\nvar modified_ts = doc[\"modified_ts\"].value;\nvar bug_id = doc[\"bug_id\"].value;\noutput=\"\";\nif (bugs.attachments!=null){ for(bugs1 : bugs.attachments){\nif (bugs1.?flags!=null){ for(bugs2 : bugs1.?flags){\nif ((bugs2.?request_status==\"?\") && ((bugs2.?request_type==\"review\") || (bugs2.?request_type==\"superreview\")) && (bugs1[\"attachments.isobsolete\"]==0) && ((bugs2.?requestee==\"msreckovic@mozilla.com\") || (bugs2.?requestee==\"bgirard@mozilla.com\") || (bugs2.?requestee==\"bjacob@mozilla.com\") || (bugs2.?requestee==\"bas.schouten@live.nl\") || (bugs2.?requestee==\"gwright@mozilla.com\") || (bugs2.?requestee==\"joe@drew.ca\") || (bugs2.?requestee==\"jmuizelaar@mozilla.com\") || (bugs2.?requestee==\"nical.bugzilla@gmail.com\"))){if (output!=\"\") output+=\"|\";\noutput+=Value2Pipe(bugs.bug_id)\n+\"|\"+Value2Pipe(bugs.modified_ts)\n+\"|\"+Value2Pipe(bugs2.?requestee)\n;\n}\n\n}}\n\n}}\noutput;\n};\n_1000(_source)\n" }} },
			"sort":[
			{"bug_version_num":{"sort":"asc"}}
		], "size":0, "from":0, "query":{"filtered":{ "filter":{"and":[
			{"range":{"expires_on":{"gt":"2013-02-02T13:58:54.000Z"}}},
			{"not":{"terms":{"bug_status":["resolved","verified","closed"]}}},
			{"and":[
				{"script":{"script":"true"}},
				{"script":{"script":"true"}},
				{"script":{"script":"true"}},
				{"terms":{"null":[ "msreckovic@mozilla.com", "bgirard@mozilla.com", "bjacob@mozilla.com", "bas.schouten@live.nl", "gwright@mozilla.com", "joe@drew.ca", "jmuizelaar@mozilla.com", "nical.bugzilla@gmail.com" ]}}
			]}
		]}, "query":{"match_all":{}} }} };


		try{
			var data = yield(Rest.post({
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/bug_version/_mapping?pretty=true",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/bug_version/_mapping",

//			"url":"http://localhost:9200/reviews/review/_search",
//			"url":"http://localhost:9200/bug_tags/bug_tags/_search",
			"url":"http://elasticsearch8.metrics.scl3.mozilla.com:9200/reviews/review/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_summary/bug_summary/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_tags/bug_tags/_search",
//				"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/org_chart/person/_search",
				"data":esQuery
			}));

			D.println(CNV.Object2JSON(data));

			var htmlSummary = CNV.ESResult2HTMLSummaries(data);
			var htmlResults = CNV.List2HTMLTable(CNV.ESResult2List(data));
			$("#info").html(htmlSummary + "<br><br>" + htmlResults);


//		while(true){
//			if (ETL.allFlags!==undefined) break;
//			yield (aThread.sleep(200));
//		}//while
//		var reviews=yield (REVIEWS.get(674239, 674240));
//		$("#info").append(CNV.List2HTMLTable(reviews));
//


		} catch(e){
			D.warning("Error sending requests", e);
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}

	});

</script>

</BODY>
</HTML>