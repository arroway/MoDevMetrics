<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
<script type="application/javascript;version=1.7" src="../js/Settings.js">
</script></HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jquery.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="../lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="../lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="../lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="../css/menu.css"/>


<script type="application/javascript;version=1.7" src="../js/aUtil.js"></script><script type="application/javascript;version=1.7" src="../js/aArray.js"></script><script type="application/javascript;version=1.7" src="../js/aString.js"></script><script type="application/javascript;version=1.7" src="../js/aMath.js"></script>
<script type="application/javascript;version=1.7" src="../js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDate.js"></script><script type="application/javascript;version=1.7" src="../js/aDuration.js"></script>

<script type="application/javascript;version=1.7" src="../js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDebug.js"></script>
<script type="application/javascript;version=1.7" src="../js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="../js/aCompiler.js"></script>


<script type="application/javascript;version=1.7" src="../js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="../js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/aChart.js"></script>

<script type="application/javascript;version=1.7" src="../js/gui/ProgramFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="../js/etl/ETL.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/Reviews.js"></script>
<script type="application/javascript;version=1.7" src="../js/etl/BugSummary.js"></script>

<div id="status"></div>
<div id="info"></div>
<h2>Simple Query</h2>

<div id="chart" style="width:800px;height:400px;"></div>
<div id="chart2" style="width:800px;height:400px;"></div>


<script type="application/javascript;version=1.7">

	aThread.run(function(){

		D.println(Date.newInstance(1352207434236).format("yyyy-NNN-dd HHmmss"));
//		yield (ESQuery.loadColumns({"from":"bugs"}));


		var esQuery = {
	"query":{"filtered":{
		"query":{"match_all":{}},
		"filter":{"and":[{"script":{"script":"true"}},{"term":{"bug_id":822870}}]}
	}},
	"from":0,
	"size":20,
	"sort":["modified_ts"],
	"facets":{"mvel":{"terms":{
		"script_field":"var Value2Pipe = function(value){\nif (value==null){ \"0\" }else if (value is ArrayList || value is org.elasticsearch.common.mvel2.util.FastList){var out = \"\";\nforeach (v : value) out = (out==\"\") ? v : out + \"|\" + Value2Pipe(v);\n'a'+Value2Pipe(out);\n}else \nif (value is Long || value is Integer){ 'n'+value; }else \nif (!(value is String)){ 's'+value.getClass().getName(); }else \n\"s\"+value.replace(\"\\\\\", \"\\\\\\\\\").replace(\"|\", \"\\\\p\");};\nvar get = function(hash, key){\nif (hash==null) null; else hash[key];\n};\nvar getDocValue = function(name){\nvar out = [];\nvar v = doc[name];\nif (v==null || v.value==null) { null; } else if (v.values.length<=1){ v.value; } else {for(k : v.values) out.add(k); out;}};\nvar _1000 = function(bugs){\nvar modified_ts = getDocValue(\"modified_ts\");\nvar expires_on = getDocValue(\"expires_on\");\nvar cf_blocking_b2g = getDocValue(\"cf_blocking_b2g\");\nvar bug_id = getDocValue(\"bug_id\");\noutput=\"\";\nif (true){output = Value2Pipe(bug_id)\n+\"|\"+Value2Pipe(cf_blocking_b2g)\n+\"|\"+Value2Pipe(modified_ts)\n+\"|\"+Value2Pipe(expires_on)\n;\n}\noutput;\n};\n_1000(_source)\n",
		"size":200000
	}}}
}

				;
//		{
//			"facets":{"mvel":{"terms":{ "size":200000, "script_field":"doc[\"dependson\"].value"}}},
//			"sort":[], "size":0, "from":0, "query":{"filtered":{ "filter":{"and":[
////			{"term":{"bug_id":180171}}  //BAD
////			{"term":{"bug_id":6625}}	//GOOD
//		]}, "query":{"match_all":{}} }} };


		try{
			var data = yield(Rest.post({
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/bug_version/_mapping?pretty=true",
			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bugs/_search",
//			"url":"http://klahnakoski-es.corp.tor1.mozilla.com:9200/raw_telemetry/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_summary/bug_summary/_search",

//			"url":"http://localhost:9200/reviews/review/_search",
//			"url":"http://localhost:9200/bug_tags/bug_tags/_search",
//			"url":"http://localhost:9200/raw_telemetry/data/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/reviews/review/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/bug_tags/bug_tags/_search",
//				"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/telemetry/_search",
//			"url":"http://elasticsearch7.metrics.scl3.mozilla.com:9200/org_chart/person/_search",
				"data":esQuery
			}));





			D.println(CNV.Object2JSON(data));

			var htmlSummary = CNV.ESResult2HTMLSummaries(data);
			var htmlResults = CNV.List2HTMLTable(CNV.ESResult2List(data));
			$("#info").html(htmlSummary + "<br><br>" + htmlResults);


//		while(true){
//			if (ETL.allFlags!==undefined) break;
//			yield (aThread.sleep(200));
//		}//while
//		var reviews=yield (REVIEWS.get(674239, 674240));
//		$("#info").append(CNV.List2HTMLTable(reviews));
//


		} catch(e){
			D.warning("Error sending requests", e);
			document.getElementById("info").innerHTML = "Response Error.  Make sure you are connected to the MPT network.";
		}

	});

</script>

</BODY>
</HTML>