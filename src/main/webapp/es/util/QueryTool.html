
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<HTML>

<HEAD>
</HEAD>
<BODY>



<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="../lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="../lib/webdetails/pvc/pvcData.js"></script>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="../lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="../lib/webdetails/pvcDocUtils.js"></script>

<link type="text/css" href="../css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="../lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="../lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="../css/menu.css"/>



<script type="application/javascript;version=1.7" src="../lib/jsonlint/jsl.format.js"></script>
<script type="application/javascript;version=1.7" src="../lib/jsonlint/jsl.parser.js"></script>
<link type="text/css" rel="stylesheet" href="../lib/jquery-linedtextarea/jquery-linedtextarea.css"/>
<script type="application/javascript;version=1.7" src="../lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>



<script type="application/javascript;version=1.7" src="../js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="../js/util.js"></script>
<script type="application/javascript;version=1.7" src="../js/aDate.js"></script>

<script type="application/javascript;version=1.7" src="../js/MozillaPrograms.js"></script>
<script type="application/javascript;version=1.7" src="../js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="../js/aCompiler.js"></script>
<script type="application/javascript;version=1.7" src="../js/MVEL.js"></script>

<script type="application/javascript;version=1.7" src="../js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="../js/CUBE.domain.js"></script>

<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="../js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/aChart.js"></script>


<script type="application/javascript;version=1.7" src="../js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="../js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="../js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="../js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="../js/filters/Filter.js"></script>
<script type="application/javascript;version=1.7" src="../js/filters/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/filters/ProductFilter.js"></script>
<script type="application/javascript;version=1.7" src="../js/filters/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="../js/filters/GUI.js"></script>


<h3>BA Query Tool</h3>
<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Ready</span><span class="loading"><img src="../images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="tools" class="parameters">
		<input id="long2date" name="long2date" value="">
		<div id="long2dateResult"></div>
	</div>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>



<div style="float:right;display: inline;">
	<a href="../http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div style="float:right;display: inline;">
	<a id="execute" class="button">EXECUTE</a>
</div>

<div style="width:800px;float: left;">
	<textarea name="cube" id="cube" style="width:800px;height:250px;"></textarea>
	<textarea name="esquery" id="esquery" style="width:800px;height:250px;"></textarea>
	<div id="result" style="overflow: scroll;width:800px;height:250px;"></div>

</div>


<script type="application/javascript;version=1.7">

	//STYLE AS LINED TEXT AREA
	$("#cube").linedtextarea();
	$("#esquery").linedtextarea();

	//SHOW SPINNER
	var found=$('.loading');
	found
		.hide()  // hide it initially
		.ajaxStart(function() {
			$(this).show();
		})
		.ajaxStop(function() {
			$(this).hide();
		})
	;

	$("#long2date").change(function(){
		var value=$(this).val();
		$("#long2dateResult").html(Date.newInstance(CNV.String2Integer(value)).format("yyyy-NNN-dd HH:mm:ss"));
	});



	$("#execute").click(function(event){
		aThread.run(window.executeCube());
	});//method

	$("#description").html("converts Cube query to ES query, and then sends to ES for a result");


	var executeCube=function(event){
		//EVAL THE CUBE
		var code=$("#cube").val();
		if (code.trim().left(1)!="{") code="{"+code;
		if (code.trim().right(1)!="}") code=code+"}";

		var cubeQuery;
		try{
			//USE JSONLINT TO FORMAT AND TEST-COMPILE THE code
			code=jsl.format.formatJson(code);
			$("#cube").val(code);
			jsl.parser.parse(code);

			var query;
			eval("query="+code);
			cubeQuery = new ESQuery(query);
//			cubeQuery.esQuery.query.size=100;
			$("#esquery").val(CNV.Object2JSON(cubeQuery.esQuery));
		}catch(e){
			$("#esquery").val(e.message);
			yield (null);
		}//try

		D.action("Sending query");

		try{
			var data=yield (cubeQuery.run());

			D.action("Got result");

			if (data.cube!==undefined){
				data.list=yield (CUBE.Cube2List(data));
				$("#result").html("<div>"+data.list.length+" rows (up to 100 shown)</div>"+CNV.List2HTMLTable(data.list, {"limit":3000}));
			}else if (data.list!==undefined){
				$("#result").html("<div>"+data.list.length+" rows (up to 100 shown)</div>"+CNV.List2HTMLTable(data.list, {"limit":3000}));
			}else{
				$("#result").html(CNV.String2HTML(CNV.Object2JSON(data)));
			}//endif
		}catch(e){
			D.action(e.message);
			$("#result").html(e.data.response);
		}//try

		D.action("Done");

	};


</script>


</BODY>
</HTML>