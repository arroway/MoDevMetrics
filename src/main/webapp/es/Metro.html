<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript;version=1.7" src="js/Settings.js">
	</script>
</HEAD>
<BODY>


<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/Base.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.js"></script>
<script type="application/javascript;version=1.7" src="lib/jstree/jquery.jstree.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/data/q01-01.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/protovis-d3.3.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/jquery.tipsy.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/lib/tipsy.js"></script>
<link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvc.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPanel.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLegend.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcPie.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcBar.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcLine.js"></script>
<script type="application/javascript;version=1.7" src="lib/webdetails/pvc/pvcData.js"></script>

<link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
<link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

<script type="application/javascript;version=1.7" src="lib/webdetails/pvcDocUtils.js"></script>


<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet"/>
<script type="application/javascript;version=1.7" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="application/javascript;version=1.7" src="lib/js/jquery.ba-bbq.js"></script>

<link type="text/css" rel="stylesheet" href="css/menu.css"/>


<script type="application/javascript;version=1.7" src="js/util.js"></script><script type="application/javascript;version=1.7" src="js/CNV.js"></script>
<script type="application/javascript;version=1.7" src="js/aDate.js"></script>
<script type="application/javascript;version=1.7" src="js/aColour.js"></script>

<script type="application/javascript;version=1.7" src="js/MozillaPrograms.js"></script><script type="application/javascript;version=1.7" src="js/MozillaDimensions.js"></script>
<script type="application/javascript;version=1.7" src="js/MozillaDimensions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/BugzillaClient.js"></script>
<script type="application/javascript;version=1.7" src="js/Bugzilla.js"></script>

<script type="application/javascript;version=1.7" src="js/Stats.js"></script>
<script type="application/javascript;version=1.7" src="js/Debug.js"></script>
<script type="application/javascript;version=1.7" src="js/MVEL.js"></script>
<script type="application/javascript;version=1.7" src="js/aCompiler.js"></script>
<script type="application/javascript;version=1.7" src="js/Hierarchy.js"></script>

<script type="application/javascript;version=1.7" src="js/aThread.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.analytic.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.aggregate.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.column.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.cube.js"></script>
<script type="application/javascript;version=1.7" src="js/CUBE.domain.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/Rest.js"></script>
<script type="application/javascript;version=1.7" src="js/ESQuery.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/aChart.js"></script>


<script type="application/javascript;version=1.7" src="js/charts/HelperFunctions.js"></script>
<script type="application/javascript;version=1.7" src="js/rest/ElasticSearch.js"></script>

<script type="application/javascript;version=1.7" src="js/charts/DataSet.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeCharts.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/RangeIterator.js"></script>
<script type="application/javascript;version=1.7" src="js/charts/DateRangeIterator.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/Filter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/ComponentFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/TeamFilter.js"></script>
<script type="application/javascript;version=1.7" src="js/gui/ProductFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/ProgramFilter.js"></script>

<script type="application/javascript;version=1.7" src="js/gui/GUI.js"></script>
<script type="application/javascript;version=1.7" src="js/etl/BugTags.js"></script>




<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>

<div id="sidebar">
	<br>
	<br>
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Chart Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>
<div style="align:left;position:relative;float:left;width:800px;">


	<h3 id="title">Metro Iterations</h3>
	<h4>Progress</h4>
	<div id="progress" class="chart"></div>


	<h4>Burndown</h4>
	<div id="burndown" class="chart"></div>


	<h4>Iterations</h4>
	<div id="summary" class="chart"></div>
	<h4>Open Bugs</h4>
	<div id="metro_open" class="chart" ></div>
	<h4>Open Points by Iteration</h4>
	<div id="iter_open" class="chart"></div>
	<h4>Total Point by Iteration</h4>
	<div id="iter_total" class="chart"></div>

	<div id="info" style="float:left;"></div>
	<div id="report"></div>

</div>

<script type="application/javascript;version=1.7">






var CUTOFF = Duration.newInstance("3week");

var thread;
var createChart = function(){
	if (thread !== undefined)
		thread.kill();
	thread = aThread.run(__createChart());
};

var __createChart = function(){

	var metro=831997;
//	var bugs = getDescendants(metro);
	//GRAB PUBLIC DESCRIPTIONS FROM BZ


	var numSample=6;
	var optimisticSample=3;
	var pessimisticSample=3;

	$("#description").html(
		"Uses up to the last "+numSample+" iterations to estimate the time to complete "+
		"the remaining backlog.  Out of those, the best "+	optimisticSample+" are used to make "+
		"an optimistic estimate, and the worst "+pessimisticSample+" are used to make "+
		"a pessimistic estimate"
	);

	var mvelToCountPoints='Math.max(1, between(coalesce(getDocValue("status_whiteboard"), " ")+" ", "p=", " ")-0)';

	//WRITE DEPENDENCY AND CLOSURE TO ES


	//CALCULATE BACKLOG OVER TIME??  OR JUST USE ALL OTHER DEPENDENCIES?
	var backlog=838081;
	var iterationParent=838829;
	var startDate=Date.newInstance("2013-01-29");
	var endDate=Date.eod();



//	var bugs={"838829":{"bug_id":838829, "dependson":["837155", "837145", "839392"]}};
	var bugs=yield(getDescendants(metro, startDate, endDate));

//	D.println(Object.keys(bugs));


	var metroSummary=yield (Q({
		"from":Map.codomain(bugs),
		"select": [
			{"name":"total", "value":"bug_id", "operation":"count"},
			{"name":"open", "value":"time.value.between(open_time, close_time) ? 1 : 0", "operation":"sum"}
		],
		"edges":[
			{"name":"date",
				"range":{"min":"open_time"},
				"domain":{"type":"time", "min":startDate, "max":endDate, "interval":"day", "value":"value"}
			}
		]
	}));

	aChart.show({
		"id":"metro_open",
		"sheetDiv":"info",
		"type":"line",
		"cube":metroSummary,
		"height":400
	});


	//

	var iterations=bugs[iterationParent].dependson.map(function(v, i){
		return bugs[v];
	}).sort(function(a, b){return CUBE.domain.value.compare(a.summary, b.summary);});
	iterations.push(bugs[backlog]);

	//startDate IS ONE DAY AFTER THE ITERATION "START", AND
	//endDATE IS 1+2 DAYS AFTER THE END (TWO DAYS TO WAIT FOR INTER-SPRINT DATA ENTRY)
	iterations[1].startDate=Date.newInstance("2013FEB5");	//SPECIAL, SPRINT INFO WAS NOT IN BZ YET
	iterations[1].endDate=Date.newInstance("2013FEB6");		//SPECIAL, DIP ON THE 7th IS NOT REPRESENTATIVE
	iterations[2].startDate=Date.newInstance("2013FEB8");
	iterations[2].endDate=Date.newInstance("2013FEB23");
	iterations[3].startDate=Date.newInstance("2013FEB27");
	iterations[3].endDate=Date.newInstance("2013MAR14");
	iterations[4].startDate=iterations[3].startDate.addWeekday(12);
	iterations[4].endDate=iterations[3].endDate.addWeekday(12);

	var currentIteration=iterations.map(function(i){if (endDate.between(i.startDate, i.endDate)) return i;})[0];


	////////////////////////////////////////////////////////////////////////////
	// BACKLOG COUNT
	////////////////////////////////////////////////////////////////////////////
	var backlogCount;
	var totalThread=aThread.run(function(){

		//THE CURRENT SPRINT IS NOT COMPLETED, SO BACKLOG SHOULD INCLUDE THOSE BUGS

		var begin=endDate.addWeekday(-12);


		backlogCount = yield (ESQuery.run({
			"from":"bugs",
			"select":{"name":"total_points", "value":mvelToCountPoints, "operation":"sum"},
			"esfilter":{"and":[
				{"terms":{"blocked":[backlog, currentIteration.bug_id]}},
				{"range":{"expires_on":{"gte": endDate.getMilli()}}},
				{"range":{"modified_ts":{"lt": endDate.getMilli()}}}
			]}
		}));

		D.println("Backlog="+backlogCount.cube.total_points);
	});

//	var allAssignedBugs=yield(getIterationRanges(bugs[iterationParent].dependson));
//	allAssignedBugs=yield(CUBE.Cube2List(allAssignedBugs));

	////////////////////////////////////////////////////////////////////////////
	// TOTAL BY ITERATION
	////////////////////////////////////////////////////////////////////////////
	var iterTotal;
	var iterTotalThread=aThread.run(function(){
		iterTotal=yield (ESQuery.run({
			"from":"bugs",
			"select":{"name":"total_points", "value":mvelToCountPoints, "operation":"sum"},
			"edges":[
				{"name":"iteration", "value":"blocked",
					domain:{"type":"set", "partitions":iterations, "value":"summary", "key":"bug_id"}
				},
				{"name":"date",
					"range":{"min":"modified_ts", "max":"expires_on"},
					"domain":{"type":"time", "min":startDate, "max":endDate, "interval":"day"}
				}
			]
		}));

		aChart.show({
			"id":"iter_total",
			"sheetDiv":"info",
			"type":"line",
			"cube":iterTotal,
			"height":400,
			"clickAction":function(series, x, d, elem){
				aThread.run(function(){
					var iteration=iterations.map(function (v, i){if (v.summary==series) return v;})[0];
					var date=Date.newInstance(x);

					var bugList=yield (ESQuery.run({
						"from":"bugs",
						"select":"bug_id",
						"esfilter":{"and":[
							{"range":{"modified_ts":{"lte":date.getMilli()}}},
							{"range":{"expires_on":{"gt":date.getMilli()}}},
							{"term":{"blocked":iteration.bug_id}}

						]}
					}));
					
					Bugzilla.showBugs(bugList.list);
				});
				return true;
			}
		});

	});


	
	////////////////////////////////////////////////////////////////////////////
	// OPEN
	////////////////////////////////////////////////////////////////////////////
	aThread.run(function(){

		var open=yield (ESQuery.run({
			"from":"bugs",
			"select":{"name":"total_points", "value":mvelToCountPoints, "operation":"sum"},
			"edges":[
				{"name":"iteration", "value":"blocked",
					domain:{"type":"set", "partitions":iterations, "value":"summary", "key":"bug_id"}
				},
				{"name":"date",
					"range":{"min":"modified_ts", "max":"expires_on"},
					"domain":{"type":"time", "min":startDate, "max":endDate, "interval":"day"}
				}
			],
			"esfilter":Mozilla.BugStatus.Open.esfilter
		}));

		aChart.show({
			"id":"iter_open",
			"sheetDiv":"info",
			"type":"line",
			"cube":open,
			"height":400
		});
	});


	////////////////////////////////////////////////////////////////////////////
	// SHOW ITERATION STATS
	////////////////////////////////////////////////////////////////////////////
	aThread.run(function(){
		yield (aThread.join(totalThread));
		yield (aThread.join(iterTotalThread));





		//FIND START AND END POINTS FOR EACH ITERATION
		//THIS SHOULD BE A UPDATE JOIN, OF SORTS
		iterations.forall(function(iter, i){
			//WE ASSUME THE iteration DIMENSION IS ORDERED LIKE OUR iterations [i]
			iter.startCount=iterTotal.cube[i][iterTotal.edges[1].domain.getPartByKey(iter.startDate).dataIndex];
			iter.endCount  =iterTotal.cube[i][iterTotal.edges[1].domain.getPartByKey(iter.endDate  ).dataIndex];
			iter.number=i;
		});


		//SHOW NUMBER 
		var status=(yield (Q({
			"from":iterations,
			"select":[
				{"name":"Completed", "value":"Util.coalesce(endCount, 0)", "operation":"sum"},
				{"name":"Current", "value":"(!endCount) ? Util.coalesce(startCount, 0) : 0", "operation":"sum"},
				{"name":"Backlog", "value":""+backlogCount.cube.total_points, "operation":"one"}
			],
			"edges":[
				{"name":"now", "value":endDate,
					"domain":{"type":"set", "partitions":[{"name":endDate.format("dd MMM yyyy"), "value":"endDate"}], "value":"name", "key":"value"}
				}
			]
		})));

		aChart.show({
			"id":"progress",
			"sheetDiv":"info",
			"type":"stacked",
			"orientation":"horizontal",
			"cube":status,
			"height":100
		});





		//RETURN BEST, AVERAGE AND WORSE
		var bestAverageWorst=function(data, optimisticSampleSize, pessimisticSampleSize){
			var sorted=data.sort(function(a, b){return a-b;});

			return {
				"average":aMath.average(data),
				"worst":aMath.average(sorted.left(pessimisticSampleSize)),
				"best":aMath.average(sorted.right(optimisticSampleSize))
			};
		};//function

		var est=bestAverageWorst(
			iterations.map(function(v, i){if (i<numSample) return v.endCount;}),
			optimisticSample,
			pessimisticSample
		);

		var remaining=backlogCount.cube.total_points;
		var numLeft={
			"average":remaining/est.average,
			"worst":remaining/est.worst,
			"best":remaining/est.best
		};

		var doneDate={
			"average":currentIteration.endDate.addWeekday(12*aMath.ceiling(numLeft.average)),
			"worst":currentIteration.endDate.addWeekday(12*aMath.ceiling(numLeft.worst)),
			"best":currentIteration.endDate.addWeekday(12*aMath.ceiling(numLeft.best))
		};


		$("#stats").html(
			'<span class="parameter_name">Completed:</span><b>'+status.Completed+' points</b><br>'+
			'<span class="parameter_name">Backlog:</span><b>'+status.Backlog+' points</b><br>'+
			'<span class="parameter_name">Avg/Iteration:</span><b>'+aMath.round(est.average, 1)+' points</b><br>'+
			'<hr><b><span style="text-align:center;font-weight: bold;">Remaining Iterations (including current)</span></b><br>'+
			'<span class="parameter_name">Best Case:</span><b>'+aMath.ceiling(numLeft.best)+' (done '+doneDate.best.format("dd-NNN-yy")+')</b><br>'+
			'<span class="parameter_name">Average Case:</span><b>'+aMath.ceiling(numLeft.average)+' (done '+doneDate.average.format("dd-NNN-yy")+')</b><br>'+
			'<span class="parameter_name">Worst Case:</span><b>'+aMath.ceiling(numLeft.worst)+' (done '+doneDate.worst.format("dd-NNN-yy")+')</b><br>'
		);

		var allIterations=[];
		for(var i=1;i<=aMath.ceiling(numLeft.worst)+currentIteration.number-1;i++){
			allIterations.push({"name":"Iteration #"+i, "number":i});
		}//for

		
		//WE KNOW THE NUMBER OF ITERATIONS NEEDED, LETS SHOW ALL SPRINTS
		var chart=yield (Q({
			"from":iterations,
			"select":[
				{"name":"Committed", "value":"Util.coalesce(startCount, 0)", "style":{"color":"mediumseagreen"}},
				{"name":"Completed", "value":"Util.coalesce(endCount, 0)",  "style":{"color":"firebrick"}}
			],
			"edges":[
				{"name":"iteration",
					"value":"number",
					"domain":{"type":"set", "partitions":allIterations, "value":"name", "key":"number"}
				}
			]
		}));
		
		aChart.show({
			"id":"summary",
			"sheetDiv":"info",
			"type":"bar",
			"cube":chart,
			"height":400
		});


		//SHOW % DONE
		remaining



	});

};





function getDescendants(parent, startDate, endDate){
//FIND DEPENDENCY FIXPOINT
	var bugs = {};
//	var orderedBugs=[];
	var lookFor = [parent];

	var metroMVP = (yield(ElasticSearch.search({
		"query":{
			"filtered":{
				"query":{"match_all":{}},
				"filter":{"and":[
					{"term":{"status_whiteboard.tokenized":"metro-mvp"}},
					{"range":{"modified_ts":{"lte":endDate.getMilli()}}},
					{"range":{"expires_on":{"gt":startDate.getMilli()}}},
					Mozilla.BugStatus.Open.esfilter
				]}
			}
		},
		"fields" : ["bug_id"],
		"sort":[],
		"size":200000,
		"from":0
	})));

	metroMVP.hits.hits.forall(function(v, i){
		if (lookFor.contains(v.fields.bug_id)) return;
		lookFor.push(v.fields.bug_id);
	});



//	var found={};
	while(true){
		var numBugs = Object.keys(bugs).length;

		var moreBugs = (yield(ElasticSearch.search({
			"query":{
				"filtered":{
					"query":{"match_all":{}},
					"filter":{"and":[
						{"terms":{"bug_id":lookFor}},
						{"range":{"modified_ts":{"lte":endDate.getMilli()}}},
						{"range":{"expires_on":{"gt":startDate.getMilli()}}},
						Mozilla.BugStatus.Open.esfilter
					]}
				}
			},
			"fields" : ["bug_id", "dependson", "status_whiteboard", "bug_version_num"],
			"sort":[],
			"size":200000,
			"from":0
		})));

		lookFor = [];
		moreBugs.hits.hits.forall(function(v, i){
			//KEEP BUG
			var b=v.fields;
			b.bug_id = b.bug_id - 0;

			//THERE IS A RISK THERE IS MORE THAN ONE "CURRENT" RECORD
			if (bugs[b.bug_id]===undefined || bugs[b.bug_id].bug_version_num<b.bug_version_num){
				bugs[b.bug_id] = b;
			}//endif

			if (b.bug_id==836963){
				D.println("");
			}

			var deps=Util.coalesce(b.dependson, []);
			deps.forall(function(w, i){
				w = w - 0;
				if (!bugs[w]){
					lookFor.push(w);
				}//endif
			});
		});
		D.println(Object.keys(bugs).length + " bugs");

		if (lookFor.length == 0) break;

	}//while

	//GO TO BZ TO GET DESCRIPTIONS
	var getBZ=aThread.run(function(){
		var temp=yield (Bugzilla.search(Object.keys(bugs), ["id", "summary"]));
		temp.forall(function(v, i){
			bugs[v.id].summary=v.summary;
		});
	});

	//AGE OF ALL BUGS FROM ES
	var getAges=aThread.run(function(){
		var ages = yield (ElasticSearch.getMinMax({"and":[
			{"terms":{"bug_id":Object.keys(bugs)}},
			Mozilla.BugStatus.Open.esfilter
		]}));

		ages=yield (CUBE.Cube2List(ages));

		ages.forall(function(v,i){
			bugs[v.bug_id].open_time=v.min;
			bugs[v.bug_id].close_time=v.max;
		});

		yield (true);
	});


	var orderedBugs=Hierarchy.topologicalSort({
		"from":bugs,
		"id_field":"bug_id",
		"children_id_field":"dependson"
	});

	var dummy=yield (aThread.join(getBZ));
	dummy=yield (aThread.join(getAges));

	//GO IN REVERSE DEPENDENCY ORDER
	for(var i=orderedBugs.length;i--;){
		var b=orderedBugs[i];

		if (!b.summary) b.summary="";
		if (b.summary.toLowerCase().trim().startsWith("epic ") || b.status_whiteboard.indexOf("feature=epic")>=0) b.type="epic";
		if (b.summary.toLowerCase().trim().startsWith("story " || b.status_whiteboard.indexOf("feature=story")>=0)) b.type="story";

		//ADD DESCENDANTS TO ALL BUGS
		if (b.dependson===undefined) b.dependson=[];
		var allD={};//OBJCET TO MAINTAIN JUST ONE RECORD PER BUG
		b.dependson.forall(function(c, i){
			if (bugs[c].descendants==undefined) return; //HAPPENS WHEN ES DOES NOT HAVE CURRENT RECORD
			bugs[c].descendants.forall(function(d, i){
				allD[d.bug_id]=d;
			});
			allD[c]=bugs[c];
		});
		b.descendants=mapAllKey(allD, function(k,v){return v;});

		b.count=b.descendants.length+1;

		//CALC THE POINT COUNT
		var points=(b.status_whiteboard+" ").between("p=", " ");
		b.points=points-0;

		//DANGER!  WILL DOUBLE COUNT IF A DAG OF DEPENDENCIES
		b.pointTotal=0;
		b.dependson.forall(function(c, i){
			b.pointTotal+=bugs[c].pointTotal;
		});
		b.pointTotal=aMath.max(b.pointTotal, b.points);

	}//for


	yield (bugs);
}//method


//"BACKLOG" bug_id, AND RANGE FO DATES TO SAMPLE
function getBacklogMembers(backlog, startDate, endDate){
//BUILD ITERATION FILTERS
	//INCLUDE BACKLOG AS AN 'ITERATION' FOR PURPOSES OF EXTRACTING POPULATION OUT OF ES
	var iterations=[{
		"name":"backlog",
		"bug_id":backlog,
		"esfilter":{"term":{"blocked":838081}}
	}];


	//ALL BUGS ATTACHED TO ITERATION OVER THE DAYS
	//MAKE GRID OF ITERATION x BUG x DAY
	//ONLY NEED iStart and iEnd FOR EVERY BUG
	var t = yield(ESQuery.run({
		"from":"bugs",
		"select":{"name":"exists", "value":"1", "operation":"count"},
		"edges":[
			{"name":"date",
				"range":{"min":"modified_ts", "max":"expires_on"},
				"allowNulls":false,
				"domain":{"type":"time", "min":startDate, "max":endDate, "interval":"day", "value":"value"}
			},
			{"name":"iteration",
				"allowNulls":true,
				"domain":{"type":"set", "key":"name", "isFacet":true, "partitions":iterations}
			},
			"bug_id"
		]
	}));
	yield t;
}//method



//function getAllHierarchy




//REQUIRES LIST OF ITERATIONS
function getIterationRanges(iterations){
//BUILD ITERATION FILTERS
	iterations = iterations.map(function(v, i){
		return {
			"name":v,
			"bug_id":v,
			"esfilter":{"term":{"blocked":v}}
		};
	});

	//GET DATE RANGE THAT EACH BUG IS PART OF EACH ITERATION
	//MUST CALL ES TWICE BECAUSE WE CAN ONLY HAVE ONE SELECT COLUMN IF WE HAVE EDGES
	var u1 = yield(ESQuery.run({
		"from":"bugs",
		"select": {"name":"min", "value":"modified_ts", "operation":"minimum"},
		"edges":[
			{"name":"iteration",
				"allowNulls":false,
				"domain":{"type":"set", "key":"name", "isFacet":true, "partitions":iterations, "value":"name"}
			},
			"bug_id"
		]
	}));

	var u2 = yield(ESQuery.run({
		"from":"bugs",
		"select": {"name":"max", "value":"expires_on", "operation":"maximum"},
		"edges":[
			{"name":"iteration",
				"allowNulls":false,
				"domain":{"type":"set", "key":"name", "isFacet":true, "partitions":iterations, "value":"name"}
			},
			"bug_id"
		]
	}));

	var u = CUBE.merge({"cubes":[
		{"from":u1, "edges":["iteration", "bug_id"]},
		{"from":u2, "edges":["iteration", "bug_id"]}
	]});
	yield u;
}//method








$(document).ready(function(){
	createChart();

});

</script>


</BODY>
</HTML>

