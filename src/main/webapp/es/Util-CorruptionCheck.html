<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript;version=1.7" src="js/aScript.js"></script>
</HEAD>
<BODY>


<div style="height: 30px; text-align: center;vertical-align:middle;">
	<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
</div>
<h3>Corrupted Bugs Within the Last Three Months:</h3>
<div id="results">Waiting for results</div>
<div id="fixes">Waiting for fixes</div>



<script type="application/javascript;version=1.7">


importScript(["js/main.js"], function(){

	//ES CAN BE OUT-OF-SYNCH WITH BZ ON PARTICULAR BUGS DURING UNSTABLE PERIODS

	Thread.run(function(){
		var result=yield (ESQuery.run({
			"from":"bugs",
			"select":{"name":"num_null", "value":"expires_on>"+Date.eod().getMilli()+" ? 1 : 0", "aggregate":"sum"},
			"edges":["bug_id"],
			"esfilter":{"range":{"modified_ts":{"gte":Date.now().addMonth(-3).getMilli()}}}
		}));

		var numBad=yield (CUBE.calc2List({
			"from":result,
			"select":[
				{"name":"bug ID", "value":"bug_id"},
				{"name":"count(expires_on==null)", "value":"num_null"}
			],
			"where":"num_null!=1"
		}));

		$("#results").html(CNV.List2HTMLTable(numBad));


		//FIX THEM?
		var broken=yield (ESQuery.run({
			"from":"bugs",
			"select":[
				{"value":"bug_id"},
				{"value":"modified_ts"},
				{"value":"expires_on"},
				{"value":"bug_version_num"}
			],
			"esfilter":{"terms":{"bug_id":numBad.list.map(function(v){return v["bug ID"];})}}
		}));

		var fixed=yield (CUBE.calc2List({
			"from":{
				"select":[
					{"value":"bug_id"},
					{"value":"modified_ts"},
					{"name":"expires_on", "value":"Date.newInstance(expires_on)==null ? null : expires_on"},
					{"value":"bug_version_num"}
				],
				"from":broken,
				"analytic":{"name":"new_expires_on", "value":"(rownum>=rows.length-1 ? null : rows[rownum+1].modified_ts)", "edges":["bug_id"], "sort":["modified_ts"]}
			},
			"select":[
				{"value":"bug_id"},
				{"value":"modified_ts"},
				{"value":"expires_on"},
				{"value":"new_expires_on"},
				{"value":"bug_version_num"}

			],
			"where":"new_expires_on != expires_on",
			"sort":["expires_on", "new_expires_on"]
		}));

		$("#fixes").html(CNV.List2HTMLTable(fixed));


	});

});
</script>


</BODY>
</HTML>
