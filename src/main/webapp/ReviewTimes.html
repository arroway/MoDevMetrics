<HTML>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <HEAD>
	</HEAD>
	<BODY>
		<script type="text/javascript" src="js/rest/RestConfig.js"></script>

		<script type="text/javascript" src="lib/js/jquery-1.7.js"></script>

	    <script type="text/javascript" src="lib/webdetails/cdf/Base.js"></script>
	    <script type="text/javascript" src="lib/webdetails/cdf/jquery.js"></script>
	    <script type="text/javascript" src="lib/webdetails/cdf/jquery.tooltip.js"></script>
	    <script type="text/javascript" src="lib/webdetails/data/q01-01.js"></script>
	    <script type="text/javascript" src="lib/webdetails/lib/protovis-d3.3.js"></script>
	    <script type="text/javascript" src="lib/webdetails/lib/jquery.tipsy.js"></script>
	    <script type="text/javascript" src="lib/webdetails/lib/tipsy.js"></script>
	    <link type="text/css" href="lib/webdetails/lib/tipsy.css" rel="stylesheet"/>

	    <script type="text/javascript" src="lib/webdetails/pvc/pvc.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcPanel.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcLegend.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcTimeseriesAbstract.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcCategoricalAbstract.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcWaterfall.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcPie.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcBar.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcLine.js"></script>
	    <script type="text/javascript" src="lib/webdetails/pvc/pvcData.js"></script>
	    <link type="text/css" rel="stylesheet" href="lib/webdetails/cdf/jquery.tooltip.css"/>
	    <link type="text/css" rel="stylesheet" href="lib/webdetails/pvcComponent.css"/>

	    <script type="text/javascript" src="lib/webdetails/pvcDocUtils.js"></script>

		<link type="text/css" href="css/start/jquery-ui-1.8.16.custom.css" rel="stylesheet" />
		<script type="text/javascript" src="lib/js/jquery-ui-1.8.16.custom.min.js"></script>
		<script type="text/javascript" src="lib/js/jquery.ba-bbq.js"></script>

	    <link type="text/css" rel="stylesheet" href="css/menu.css"/>


        <script type="text/javascript" src="js/CNV.js"></script>
		<script type="text/javascript" src="js/aDate.js"></script>
        <script type="text/javascript" src="js/Test2.js"></script>
        <script type="text/javascript" src="js/MozillaPrograms.js"></script>
        <script type="text/javascript" src="js/util.js"></script>
		<script type="text/javascript" src="js/Debug.js"></script>
		<script type="text/javascript" src="js/MVEL.js"></script>
		<script type="text/javascript" src="js/sql.js"></script>
		<script type="text/javascript" src="../../test/js/SQL.js"></script>



        <script type="text/javascript" src="js/charts/HelperFunctions.js"></script>
        <script type="text/javascript" src="js/rest/RestQuery.js"></script>
        <script type="text/javascript" src="js/charts/Status.js"></script>
        <script type="text/javascript" src="js/charts/DataSet.js"></script>
        <script type="text/javascript" src="js/charts/RangeCharts.js"></script>
        <script type="text/javascript" src="js/charts/RangeIterator.js"></script>
        <script type="text/javascript" src="js/charts/DateRangeIterator.js"></script>

        <script type="text/javascript" src="js/filters/Filter.js"></script>
        <script type="text/javascript" src="js/filters/ComponentFilter.js"></script>
        <script type="text/javascript" src="js/filters/ProductFilter.js"></script>
        <script type="text/javascript" src="js/filters/ProgramFilter.js"></script>
        <script type="text/javascript" src="js/filters/CustomFilters.js"></script>
        <script type="text/javascript" src="js/filters/GUIFilters.js"></script>

		<table style="width: 100%;">
		<tr>
		<td style="width: 300px;  vertical-align:text-top;">
				<div id="filters" class="menu"></div>
				<div id="testMessage"></div>
		</td>
		<td style="vertical-align:text-top;">
			<table style="margin-left: auto; margin-right: auto; border: 0px solid black;">
				<tr>
					<td style="width: 800px; height: 100px; margin-left: auto; margin-right: auto;">
						<div style="text-align: center;font:10px arial,sans-serif;">
							Start Date <input type="text" id="startDate"><input type="text" id="endDate"> End Date
						</div>
					</td>
				</tr>
			</table>
			<table style="margin-left: auto; margin-right: auto; border: 1px solid black;">
				<tr>
					<td style="width: 800px; height: 400px; margin-left: auto; margin-right: auto;">
						<div id="chart"></div>
					</td>
				</tr>
				<tr>
					<td>
						<div id="status" style="text-align: center; font:10px arial,sans-serif;">Chart Loading...</div>
					</td>
				</tr>
				<tr>
					<td>
						<div id="progressbar" style="height: 10px; width: 200px; margin-left: auto; margin-right: auto;"></div>
					</td>
				</tr>
			</table>
			</td>
			</tr>
		</table>
		<div id="info"></div>
        <div id="description"></div>
        <div id="report"></div>

		<script type="text/javascript">

		GUI.GetURLState();

		var rangeChart = null;

		var chartRequest = {
			"requests" :[
				{"esQuery" : {
					"query":{"filtered":{
						"query": {
							"match_all" : {}
						},
						"filter" : {
							"and":[
								{ "terms" : { "status_whiteboard.tokenized" : ["snappy", "snappy:p1", "snappy:p2", "snappy:p3"]}}
							]
						}
					}},
					"from" : 0,
					"size" : 0,
					"sort" : [],
					"facets":{
						"inReview": {
							"terms":{
								"script_field":
									new MVEL().code({
										"select" : [
											{"name":"bug_id", "value":"doc.bug_id"},
											{"name":"modified_ts", "value":"doc.modified_ts"}//,
	//										{"name":"requestee", "value":"doc.attachments.flags.requestee"}
										],
										"from":
											"doc.attachments.flags",
										"where":
											{"and" : [
												{"or" : [
													 { "and" : [
														 {"terms" : {"doc.attachments.flags.request_status" : ["?"]}},
														 {"terms" : {"doc.attachments.flags.request_type" : ["review", "superreview"]}}
													 ]}
												]},
												{"term":{"doc.attachments[\"attachments.isobsolete\"]" : 0}}
											 ]}
									}),
								"size": 100000
							}
						},
						"doneReview" : {
							"terms":{
								"script_field":
									new MVEL().code({
										"select" : [
											{"name":"bug_id", "value":"doc.bug_id"},
											{"name":"modified_ts", "value":"doc.modified_ts"}//,
	//										{"name":"requestee", "value":"doc.attachments.flags.requestee"}
										],
										"from":
											"doc.attachments.flags",
										"where":
											{"and" : [
												{"or" : [
													 { "and" : [
														 {"not": {"terms" : {"doc.attachments.flags.request_status" : ["?"]}}},
														 {"terms" : {"doc.attachments.flags.request_type" : ["review", "superreview"]}}
													 ]}
												]},
												{"term":{"doc.attachments[\"attachments.isobsolete\"]" : 0}}
											 ]}
									}),
								"size": 100000
							}
						}
					}
				},
				"seriesName" : "Open Bugs"
				}
			],
			"chartTitle" : "Burndown",
			"canvas" : "chart",
			"originZero" : true,
			"chartType" : "LineChart",
			"groupSize" : 1,
			"startDate" : state["startDate"],
			"endDate" : state["endDate"]
		};


		var createChart = function(){
			if (rangeChart != undefined ){
				rangeChart.Kill();
			}
			
			ES.InjectFilters( chartRequest.requests );

			console.log("chartRequest: " + JSON.stringify(chartRequest));

			rangeChart = new RangeChart(chartRequest);
			rangeChart.run();
		};



	RestQuery.Run(
		{
		"success" : function(requestObj, data){
			var inReview=CNV.ESFacet2List(data.facets.inReview);
			var doneReview=CNV.ESFacet2List(data.facets.doneReview);

			var trackedBugs=new SQL().calc({
				"from":
					inReview,
				"select":[

				],
				"facets":[
					{"name":"bug_id", "value":"bug_id"}
				]
			});

			var durations=new SQL().calc({
				"from":
					inReview,
//					{"name":"i", "list":data.facets.identified},
				"select":[
					{"name":"reviewTime", "value":"c.modified_ts-modified_ts", "operation":"minimum"}
				],
				"facets":[
					{"name":"bug_id", "test":"bug_id==c.bug_id && modified_ts<c.modified_ts", "domain":{"type":"set", "name":"c", "key":"bug_id", "list":doneReview}},
					{"name":"request_time", "value":"modified_ts"}
				]
			});

			var time2res=new SQL().calc({
				"from":
					durations,
				"select":[
					{"name":"count", "value":"1", "operation":"count"}
				],
				"facets":[
					{"name":"reviewTime", "value":"Duration.newInstance(reviewTime)", "domain":{"type":"duration", "min":0, "max":"7day", "interval":"6hour"}}
				]
			});

			$("#info").html(CNV.List2HTMLTable(time2res));

		},

		"error": function(requestObj, errorData, errorMsg, errorThrown){
			D.error(errorMsg)
		}
		},
		0,
		chartRequest.requests[0].esQuery
	);

	var filterUI = null;

//	$(document).ready(function(){
//			GUI.setup();
//			createChart();
//	});

	//Code for updating URL paramaters: window.location('address_goes_here');
	</script>



	</BODY>
</HTML>