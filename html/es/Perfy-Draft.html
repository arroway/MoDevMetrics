<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript;version=1.7" src="lib/jsImport/js/import.js"></script>
</HEAD>
<BODY>

<div id="sidebar">
	<br>
	<br>

	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title">Perfy!</h3>
	<div id="chart" class="chart" style="float:none;width:800px;height:400px;"></div>
	<div id="confidence" class="confidence" style="float:none;width:800px;height:400px;"></div>
	<div id="info"></div>
	<div id="details"></div>
</div>


<script type="application/javascript;version=1.7">


importScript(['js/main.js', 'js/Dimension-Perfy.js'], function(){
	//POINT TO KNOWN CLUSTER
	ElasticSearch.baseURL = "http://klahnakoski-es.corp.tor1.mozilla.com:9200";
//	ElasticSearch.baseURL = "http://localhost:9200";

	var thread;
	var createChart = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	var __createChart = function(){
		var sampleDate = Date.newInstance(GUI.state.date);
		var benchmark=GUI.state.benchmark;

		var totalsFilter={"terms":{"info.test":["total", "Kraken", "Octane"]}};

		//DIFFICULT TO FIND TEST DATA, LOOK FOR LATEST IN EACH COMBO
//		var max_date=yield (ESQuery.run({
//			"from":"perfy",
//			"select":{"value":"info.started", "aggregate":"max"},
//			"edges":[
//				{"name":"Browser", "domain":Mozilla.Perfy.Browser.getDomain()},
//				{"name":"Test", "domain":Mozilla.Perfy.Benchmark.getDomain({"depth":1})}
//			],
//			"esfilter":{"and":[
//				{"not":totalsFilter}, //IGNORE AGGREGATE VALUES
//				{"range":{"info.started":{"lt":sampleDate.ceilingDay().getMilli()}}},
//				GUI.getFilters("perfy")
//			]}
//		}));



		var esfilter={"and":[
			{"not":totalsFilter}, //IGNORE AGGREGATE VALUES
			{"range":{"info.started":{"gte":sampleDate.floorDay().getMilli(), "lt":sampleDate.ceilingDay().getMilli()}}},
			GUI.getFilters("perfy")
		]};




		while (Mozilla.Perfy.Benchmark.partitions instanceof Thread){
			yield (Thread.sleep(200));
		}//while


		Thread.run(function(){
			var data = yield(ESQuery.run({
				"name":"Results for"+GUI.state.benchmark.getSimpleState(),
				"from":"perfy",
				"select": {"name":"score", "value":"score", "aggregate":"average"},
				"edges":[
					{"name":"Browser", "domain":Mozilla.Perfy.Browser.getDomain()},
					{"name":"Test", "domain":Mozilla.Perfy.Benchmark.getDomain({"depth":1})}
				],
				"esfilter":esfilter
			}));

			//REMOVE ZERO EDGES
			CUBE.removeZeroParts(data, 0);
			CUBE.removeZeroParts(data, 1);


			aChart.show({
				"id":"chart",
				"sheetDiv":"info",
				"type":"bar",
				"stacked":false,
				"cube":data,
				"legendPosition":"right",
				"legendSize":150,
				xAxisSize: 100,
				extensionPoints: {
					line_lineWidth: 2
				}
			});
		});

		


		Thread.run(function(){
			var data = yield(ESQuery.run({
				"name":"Results",
				"from":"perfy",
				"select": [
					Mozilla.Perfy.Browser.getSelect(),
					Mozilla.Perfy.Benchmark.getSelect({"depth":1}),
					{"name":"score", "value":"score"}
				],
				"esfilter":esfilter
			}));

			var range=yield (Q({
				"from":data,
				"select":
					{"value":"score", "aggregate":"array", "sort":1}
				,
				"edges":[
					{"name":"Browser", "value":"Browser"},
					{"name":"Benchmark", "value":"Benchmark"}
				]
			}));

			var domain=Mozilla.Perfy.Benchmark.getDomain({"depth":1});
			domain.partitions=domain.partitions.map(function(v){
				return v.name;
			});
//			domain.partitions.sort();

			var range2=yield (Q({
				"from":range,
				"select":
					//REPORT 90% OF VALUES
					{"name":"range", "value":"(function(){if (score.length<2) return 0; var n=Math.floor(score.length/20); return score[score.length-1-n]-score[n];})()"}
				,
				"edges":[
					{"name":"Browser", "value":"Browser", "domain":Mozilla.Perfy.Browser},
					{"name":"Benchmark", "value":"Benchmark", "domain":{"type":"set", "partitions":domain.partitions}}
				]
			}));

			CUBE.removeZeroParts(range2, 0);
			CUBE.removeZeroParts(range2, 1);

			aChart.show({
				"name":"Range of Middle 90%",
				"id":"confidence",
				"sheetDiv":"info",
				"type":"bar",
				"stacked":false,
				"cube":range2,
				"legendPosition":"right",
				"legendSize":150,
				xAxisSize: 100,
				extensionPoints: {
					line_lineWidth: 2
				}
			});
		});


	};
	

	$(document).ready(function(){
		GUI.setup(createChart, [
				{"id":"date", "name":"Test Date", "type":"date", "default":Date.getDateFromFormat("2013-Sep-03", "yyyy-MMM-dd")},
				{"id":"benchmark", "name":"Benchmark", "type":PartitionFilter.newInstance({
					"id":"benchmark",
					"name":"Benchmark",
					"dimension":Mozilla.Perfy.Benchmark,
					"onlyOne":true,
					"expandAll":true
				})},
				{"id":"platform", "name":"Platform", "type":PartitionFilter.newInstance({
					"id":"platform",
					"name":"Platform",
					"dimension":Mozilla.Perfy.Platform,
					"onlyOne":true,
					"expandAll":true
				})}
			],
			[
			],
			"perfy",
			false
		);
	});

});

</script>


</BODY>
</HTML>

