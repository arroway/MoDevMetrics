<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>FFOS Regressions</title>
	<script type="application/javascript" src="js/imports/import.js"></script>
</HEAD>
<BODY style="display: none;">
<div style="overflow:hidden;">
	<div id="sidebar">
		<div id="description">
			Each component is colored on a continuous scale (<div style="vertical-align:middle;height:15px; width:150px; background: -moz-linear-gradient(left, #009F00,#699B00,  #CA7900,#954000, #A50303);position: relative;display:inline-block;">
							<div style="top:-3px;left:1px;color:white;position: absolute;font-size: 15px">New</div>
							<div style="top:-3px;right:1px;color:white;position: absolute;font-size: 15px">Old</div>
						</div>)
			according to the age of it's oldest member.  Green is new, while red is 7days or older.
			If the component has unassigned members, then it is marked with a <div style="display:inline-block;bottom:0;width: 0;height: 0; border-style: solid; border-width: 0 0 15px 15px; border-color: transparent transparent #000000 transparent;"></div>
			 along with the count.
		</div>

		<hr>
		<div id="filters" style="width:300px;" class="menu">
		</div>
	</div>
	<div class="sidebar_name">
		<div>Filters</div>
	</div>
	<div class="content">
		<h3>FFOS Regressions</h3>
		<div id="blockers"></div>
	</div>
</div>
<div class="footer">
	Source at <a href="https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Regressions.html">https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Regressions.html</a>
</div>
<script type="application/javascript">

	importScript([
		'b2g/blockers.css',
		'js/main.js',
		'js/Dimension-Bugzilla.js',
		"js/Dimension-B2G.js",
		"js/charts/aColor.js",
		"b2g/heat.js"
	], function () {
		heatCommon();

		var thread;
		function createChart() {
			if (thread !== undefined)
				thread.kill(true);
			thread = Thread.run(__createChart());
		}
		refresher(createChart);

		var __createChart = function*() {
			yield (ESQuery.loadColumns({"from": "bugs"}));

			var a = Log.action("Get Bug Details", true);
			//PULL THE RAW DATA, AND THEN OPERATE ON IT 112K, 2.17sec time
			//THE AGGREGATES ARE SPENDING ABOUT 2/3 THE TIME TRANSMITTING THE QUERY
			var allDetails = yield(ESQuery.run({
				"from": "bugs",
				"select": [
					"bug_id",
					"modified_ts",
					"keywords",
					"assigned_to",
					"component",
					"product",
					"cf_blocking_b2g",
					"target_milestone"
				],
				"esfilter": {"and": [
					{"term": {"keywords": "regression"}},
					Mozilla.B2G.esfilter,
					Mozilla.BugStatus.Open.esfilter,
					Mozilla.CurrentRecords.esfilter,
					GUI.getFilters("bugs")
				]}
			}));
			Log.actionDone(a);

			var components = yield(Q({
				"from": allDetails,
				"select": [
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"},
					{"name": "bugs", "value": "bug_id", "aggregate": "array"},
					{"name": "unassigned_bugs", "value": '(assigned_to=="nobody@mozilla.org" ? bug_id : null)', "aggregate": "array"}
				],
				"edges": [
					"component",
					{"name": "project", "domain": Mozilla.B2G.Project.getDomain()}
				]
			}));

			$("#blockers").html("");
			components.cube.forall(function (component, i) {
				var total = aMath.sum.apply(undefined, component.select("count"));
				if (total > 0) {
					component.forall(function (project, j) {
						project.component = components.edges[0].domain.partitions[i].name;
						project.project = components.edges[1].domain.partitions[j].name;
						project.total = total;
					});
					var blockerHTML = showComponent(component, showRegression);
					$("#blockers").append(blockerHTML);
				}//endif
			});

			addProjectClickers(components);
		};

		$(document).ready(function () {
			GUI.setup(
					createChart,
					[
						{"id": "project", "name": "Releases", "type": PartitionFilter.newInstance({
							"id": "Projects",
							"name": "All Projects",
							"dimension": Mozilla.B2G.Project,
							"onlyOne": false,
							"expandAll": true
						})},
						{"id": "team", "name": "Teams", "type": PartitionFilter.newInstance({
							"id": "Teams",
							"name": "All Teams",
							"dimension": Mozilla.B2G.Team,
							"onlyOne": true,
							"expandAll": true
						})},
						{"id": "component", "name": "Components", "type": PartitionFilter.newInstance({
							"id": "Components",
							"name": "All Components",
							"dimension": Mozilla.B2G.Component,
							"onlyOne": false,
							"expandAll": true
						})}
					],
					[],
					null,
					false		//DO NOT SHOW DEFAULT FILTERS
			);
		});
	});
</script>


</BODY>
</HTML>




