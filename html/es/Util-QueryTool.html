<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>

<HEAD>
	<script type="application/javascript;version=1.7" src="lib/jsImport/js/import.js"></script>
</HEAD>
<BODY>


<h3>BA Query Tool</h3>

<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Ready</span><span class="loading"><img src="../images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="tools" class="parameters">
		<input id="long2date" name="long2date" value="">

		<div id="long2dateResult"></div>
	</div>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>


<div style="float:right;display: inline;">
	<a href="../http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div style="float:right;display: inline;">
	<a id="execute" class="button">EXECUTE</a>
</div>

<div style="width:800px;float: left;">
	<textarea name="cube" id="cube" style="width:800px;height:250px;"></textarea>
	<textarea name="esquery" id="esquery" style="width:800px;height:250px;"></textarea>

	<div id="result" style="overflow: scroll;width:800px;height:250px;"></div>
</div>


<script type="application/javascript;version=1.7">


	importScript(["js/main.js"], function(){


		//STYLE AS LINED TEXT AREA
		$("#cube").linedtextarea();
		$("#esquery").linedtextarea();
		$("#description").html("converts Cube query to ES query, and then sends to ES for a result");


		$("#long2date").change(function(){
			var value = $(this).val();
			$("#long2dateResult").html(Date.newInstance(CNV.String2Integer(value)).format("yyyy-NNN-dd HH:mm:ss") + "<br>" +
					Date.newInstance(CNV.String2Integer(value)).toString());
		});

		var executeCube = function(event){ //THIS IS A GENERATOR

			//EVAL THE CUBE
			var code = $("#cube").val();
			if (code.trim().left(1) != "{") code = "{" + code;
			if (code.trim().right(1) != "}") code = code + "}";

			var backupCode = code;
			var cubeQuery;
			try{
				//USE JSONLINT TO FORMAT AND TEST-COMPILE THE code
				code = jsl.format.formatJson(code);
				$("#cube").val(code);
				jsl.parser.parse(code);

				var query;
				eval("query=" + code);
				yield(ESQuery.loadColumns(query));
				cubeQuery = new ESQuery(query);
				$("#esquery").val(CNV.Object2JSON(cubeQuery.esQuery));

				//TIGHTER PACKING IF JSON
				$("#cube").val(CNV.Object2JSON(CNV.JSON2Object(backupCode)));
			} catch(e){
				$("#esquery").val(e.message);
				yield(null);
			}//try

			var a = Log.action("Sending query", true);

			try{
				var data = yield(cubeQuery.run());

				Log.action("Got result");

				if (data.cube !== undefined){
					data.list = yield(CUBE.Cube2List(data));
					$("#result").html("<div>" + data.list.length + " rows (up to 100 shown)</div>" + CNV.List2HTMLTable(data.list, {"limit":3000}));
				} else if (data.list !== undefined){
					$("#result").html("<div>" + data.list.length + " rows (up to 100 shown)</div>" + CNV.List2HTMLTable(data.list, {"limit":3000}));
				} else{
					$("#result").html(CNV.String2HTML(CNV.Object2JSON(data)));
				}//endif
			} catch(e){
				Log.action(e.message);
				if (e.data !== undefined) $("#result").html(e.data.response);
			}//try

			Log.actionDone(a);
		};


		$("#execute").click(function(event){
			Thread.run(executeCube());
		});//method
	});
</script>


</BODY>
</HTML>