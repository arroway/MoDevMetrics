<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>FFOS Nominations</title>
	<script type="text/javascript">function importScript(dep, func){if (func!==undefined) func();}</script>
	<script type="text/javascript" src="js/Settings.js"></script>
	<script type="text/javascript" src="js/rest/BugzillaClient.js"></script>
	<link type="text/css" rel="stylesheet" href="b2g/blockers.css"/>
	<script type="text/javascript" src="js/util/aUtil.js"></script>
	<script type="text/javascript" src="js/util/aString.js"></script>
	<script type="text/javascript" src="b2g/owners.js"></script>
	<script type="text/javascript" src="js/collections/aMatrix.js"></script>
	<script type="text/javascript" src="js/qb/Qb.aggregate.js"></script>
	<script type="text/javascript" src="js/qb/Qb.column.js"></script>
	<script type="text/javascript" src="js/qb/Qb.cube.js"></script>
	<script type="text/javascript" src="js/qb/Qb.analytic.js"></script>
	<script type="text/javascript" src="js/gui/Filter.js"></script>
	<script type="text/javascript" src="js/gui/ComponentFilter.js"></script>
	<script type="text/javascript" src="js/gui/PartitionFilter.js"></script>
	<script type="text/javascript" src="js/qb/aCompiler.js"></script>
	<script type="text/javascript" src="js/collections/aArray.js"></script>
	<script type="text/javascript" src="js/util/aParse.js"></script>
	<script type="text/javascript" src="js/collections/aRelation.js"></script>
	<script type="text/javascript" src="js/math/aMath.js"></script>
	<script type="text/javascript" src="js/MozillaPrograms.js"></script>
	<script type="text/javascript" src="js/util/CNV.js"></script>
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="js/util/aDate.js"></script>
	<script type="text/javascript" src="js/collections/aQueue.js"></script>
	<script type="text/javascript" src="js/collections/aSet.js"></script>
	<script type="text/javascript" src="js/debug/aException.js"></script>
	<script type="text/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
	<script type="text/javascript" src="lib/jquery.numberformatter.js"></script>
	<script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>
	<script type="text/javascript" src="js/qb/Qb.domain.js"></script>
	<script type="text/javascript" src="js/util/aDuration.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css">
	<script type="text/javascript" src="js/aFormat.js"></script>
	<script type="text/javascript" src="js/gui/TeamFilter.js"></script>
	<script type="text/javascript" src="js/debug/aLog.js"></script>
	<script type="text/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>
	<script type="text/javascript" src="js/threads/thread.js"></script>
	<script type="text/javascript" src="js/gui/ProgramFilter.js"></script>
	<script type="text/javascript" src="js/util/aTimer.js"></script>
	<script type="text/javascript" src="lib/jsonlint/jsl.format.js"></script>
	<script type="text/javascript" src="js/rest/Rest.js"></script>
	<script type="text/javascript" src="js/aLibrary.js"></script>
	<script type="text/javascript" src="lib/jsonlint/jsl.parser.js"></script>
	<script type="text/javascript" src="js/rest/ElasticSearch.js"></script>
	<script type="text/javascript" src="js/Bugzilla.js"></script>
	<script type="text/javascript" src="js/math/Stats.js"></script>
	<script type="text/javascript" src="js/qb/MVEL.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css">
	<script type="text/javascript" src="js/qb/Qb.js"></script>
	<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
	<script type="text/javascript" src="js/qb/ESQuery.js"></script>
	<script type="text/javascript" src="js/Dimension.js"></script>
	<script type="text/javascript" src="js/Dimension-Bugzilla.js"></script>
	<script type="text/javascript" src="js/Dimension-B2G.js"></script>
	<script type="text/javascript" src="js/gui/ProductFilter.js"></script>
	<script type="text/javascript" src="js/charts/aColor.js"></script>
	<script type="text/javascript" src="js/gui/GUI.js"></script>
	<script type="text/javascript" src="b2g/heat.js"></script>
	<link type="text/css" rel="stylesheet" href="css/menu.css">
	<script type="text/javascript" src="b2g/main_lib.js"></script>
	<style id="vakata-stylesheet" type="text/css"></style>
	<style id="jstree-stylesheet" type="text/css"></style>
	<link rel="stylesheet" type="text/css" media="all" href="http://people.mozilla.orglib/jstree/themes/default/style.css">

</HEAD>
<BODY style="display: none;">
<div style="overflow:hidden;">
	<div id="sidebar">
		<div id="description" style="width:300px;">
			Each component is colored on a continuous scale (<div style="vertical-align:middle;height:15px; width:150px; background: -moz-linear-gradient(left, #009F00,#699B00,  #CA7900,#954000, #A50303);position: relative;display:inline-block;">
							<div style="top:-3px;left:1px;color:white;position: absolute;font-size: 15px">New</div>
							<div style="top:-3px;right:1px;color:white;position: absolute;font-size: 15px">Old</div>
						</div>)
			according to the time since the earliest nomination.  Green is new, while red is 7days or older.
			If the component has unassigned members, then it is marked with a <div style="display:inline-block;bottom:0;width: 0;height: 0; border-style: solid; border-width: 0 0 15px 15px; border-color: transparent transparent #000000 transparent;"></div>
			 along with the count.
		</div>

		<hr>
		<div id="filters" style="width:300px;" class="menu">
		</div>
	</div>
	<div class="sidebar_name">
		<div>Filters</div>
	</div>
	<div class="content" style="position:inherit;">
		<div id="totals"><h3 style="display:inline-block;">FFOS Nominations</h3></div>
		<div style="position:absolute;top:5px;right:10px;">
			Age: <div style="vertical-align:middle;height:15px; width:150px; background: -moz-linear-gradient(left, #009F00,#699B00,  #CA7900,#954000, #A50303);position: relative;display:inline-block;"><div style="top:-3px;left:1px;color:white;position: absolute;font-size: 15px">New</div><div style="top:-3px;right:1px;color:white;position: absolute;font-size: 15px">7days+</div></div><br>
		</div>
		<div id="blockers"></div>
	</div>
	<div class="footer">
		Source at <a href="https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Nominations.html">https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Nominations.html</a>
	</div>
</div>
<script type="application/javascript">

	importScript('b2g/main_lib.js', function () {
		heatCommon();

		var thread;
		function createChart() {
			if (thread !== undefined)
				thread.kill(true);
			thread = Thread.run(__createChart());
		}
		refresher(createChart);

		var __createChart = function*() {
			yield (ESQuery.loadColumns({"from": "bugs"}));

			//PULL THE RAW DATA, AND THEN OPERATE ON IT 112K, 2.17sec time
			//THE AGGREGATES ARE SPENDING ABOUT 2/3 THE TIME TRANSMITTING THE QUERY
			var allDetails=[];
			var allDetailsThread=Thread.run(function*(){
				var a = Log.action("Get Bug Details", true);
				allDetails = yield(ESQuery.run({
					"from": "bugs",
					"select": [
						"bug_id",
						"modified_ts",
						"keywords",
						"assigned_to",
						"component",
						"product",
						"cf_blocking_b2g"
					],
					"esfilter": {"and": [
						{"terms": {"cf_blocking_b2g": ["1.3?", "1.4?", "1.3t?"]}},
						Mozilla.BugStatus.Open.esfilter,
						Mozilla.CurrentRecords.esfilter,
						GUI.getFilters("bugs")
					]}
				}));
				Log.actionDone(a);
			});

			var ages=yield(ESQuery.run({
				"from":"bugs",
				"select":{"value":"modified_ts", "aggregate":"minimum"},
				"edges":["bug_id"],
				"esfilter": {"and": [
					{"terms": {"cf_blocking_b2g": ["1.3?", "1.4?", "1.3t?"]}},
					Mozilla.BugStatus.Open.esfilter
				]}
			}));

			yield (Thread.join(allDetailsThread));

			//MAP THE TIMESTAMP TO THE DETAIL RECORD
			var domain=ages.edges[0].domain;
			allDetails.list.forall(function(d){
				d.modified_ts=ages.cube[domain.getPartByKey(d.bug_id).dataIndex];
			});

			var components = yield(Q({
				"from": allDetails,
				"select": [
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"}
				],
				"edges": [
					"component",
					{"name": "project", "domain": Mozilla.B2G.Project.getDomain()}
				]
			}));

			$("#blockers").html("");
			components.cube.forall(function (component, i) {
				var total = aMath.sum.apply(undefined, component.select("count"));
				if (total > 0) {
					component.forall(function (project, j) {
						project.component = components.edges[0].domain.partitions[i].name;
						project.project = components.edges[1].domain.partitions[j].name;
						project.total = total;
					});
					var blockerHTML = showComponent(component, showNominations);
					$("#blockers").append(blockerHTML);
				}//endif
			});

			var projectDomain=Mozilla.B2G.Project.getDomain();
			projectDomain.end=function(p){return p.name;};
			var totals = yield(Q({
				"from": allDetails,
				"select": [
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"}
				],
				"edges": [
					{"name": "project", "domain": projectDomain}
				]
			}));

			var blockerHTML = showSummary("Nominations", GUI.state.team.getSelectedParts(), totals, showNominations);
			$("#totals").html(blockerHTML);

			addProjectClickers(components);
		};

		$(document).ready(function () {
			GUI.setup(
					createChart,
					[
						{"id": "project", "name": "Releases", "type": PartitionFilter.newInstance({
							"id": "Projects",
							"name": "All Projects",
							"dimension": Mozilla.B2G.Project,
							"onlyOne": false,
							"expandAll": true
						})},
						{"id": "team", "name": "Teams", "type": PartitionFilter.newInstance({
							"id": "Teams",
							"name": "All Teams",
							"dimension": Mozilla.B2G.Team,
							"onlyOne": true,
							"expandAll": true
						})},
						{"id": "component", "name": "Components", "type": PartitionFilter.newInstance({
							"id": "Components",
							"name": "All Components",
							"dimension": Mozilla.B2G.Component,
							"onlyOne": false,
							"expandAll": true
						})}
					],
					[],
					null,
					false		//SHOW DEFAULT FILTERS?
			);
		});
	});
</script>


</BODY>
</HTML>




