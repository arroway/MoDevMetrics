<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="application/javascript" src="js/imports/import.js"></script>
</HEAD>
<BODY>

<div id="sidebar">
	<br>
	<br>

	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px"></span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description">Incomplete<br><br>
	</div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>


<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title">Incomplete!  These numbers have not been verified!</h3>

	<!--<div id="headerTriage" class="header">Bug Triage (show close rates? (per month?)</div>-->
	<!--<div id="expandTriage" class="expando">-->
		<!--<div id="chartTriage" class="chart" style="float:none;width:800px;height:300px;"></div>-->
		<!--<div id="detailTriage"></div>-->
	<!--</div>-->

	<!--<div class="header">Bug Counts (show current blocker/regression totals)</div>-->
	<!--<div id="count" class="expando">-->
		<!--<div id="chartCount" class="chart" style="float:none;width:800px;height:300px;"></div>-->
		<!--<div id="chartPercent" class="chart" style="float:none;width:800px;height:300px;"></div>-->

		<!--<div id="detailBlocker"></div>-->
		<!--<div id="detailRegression"></div>-->
	<!--</div>-->

	<div id="headerChurn" class="header">Bug Churn (show close rates? (per month?)</div>
	<div id="expandChurn" class="expando">
		<div id="chartChurn" class="chart" style="float:none;width:800px;height:300px;"></div>
	</div>

	<div id="headerReview" class="header">Reviews (show count)</div>
	<div id="detailReview" class="expando"></div>


	<br><br>

	<div id="info"></div>
	<div id="details"></div>
</div>


<script type="application/javascript">


importScript(['js/main.js', 'js/Dimension-Bugzilla.js', "js/Dimension-B2G.js"], function () {


	$(document).bind('keydown keyup', function (e) {
		if (e.which === 116 || (e.which === 82 && e.ctrlKey)) {
			reloadScripts();
			return false;
		}
	});


	var thread;
	var createChart = function () {
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	var __createChart = function*() {
		var BLOCKERS = ["1.3+", "1.3t", "1.4+", "1.5+"];

		var sampleMin = Date.newInstance(GUI.state.sampleMin);
		var sampleMax = Date.newInstance(GUI.state.sampleMax).addDay(1);
		var sampleInterval = Duration.newInstance(GUI.state.sampleInterval);



		var mainFilter = {"and":[
			GUI.getFilters("bugs"),
			{"or": [
				{"terms": {"cf_blocking_b2g": ["1.3+", "1.3t+", "1.4+", "1.5+"]}},
				{"term": {"product": "firefox os"}}
			]}
		]};

//		Thread.run(function*() {
//			///////////////////////////////////////////////////////////////////////
//			// SIMPLE OPEN BUG COUNT, OVER TIME
//			///////////////////////////////////////////////////////////////////////
//
//			var chart = yield (ESQuery.run({
//				"name": "Open Bug Count",
//				"from": "bugs",
//				"select": {
//					"name": "num_bug",
//					"value": "bug_id",
//					"aggregate": "count"
//				},
//				"edges": [
//					{"name": "blocker", "esfilter": ESQuery.TrueFilter, "domain": {"isFacet": true, "partitions": [
//						{"name": "open", "value": "open", "esfilter": {"and": [
//							{"not": {"term": {"keywords": "regression"}}},
//							{"not": {"terms": {"cf_blocking_b2g": BLOCKERS}}}
//						]}},
//						{"name": "blocker", "value": "blocker", "esfilter": {"and": [
//							{"not": {"term": {"keywords": "regression"}}},
//							{"terms": {"cf_blocking_b2g": BLOCKERS}}
//						]}},
//						{"name": "regression", "value": "regression", "esfilter": {"term": {"keywords": "regression"}}}
//					]}},
//					{"name": "date",
//						"range": {
//							"min": "modified_ts",
//							"max": "expires_on"
//						},
//						"allowNulls": false,
//						"domain": {
//							"type": "time",
//							"min": sampleMin,
//							"max": sampleMax.add(sampleInterval),
//							"interval": sampleInterval
//						}
//					}
//				],
//				"esfilter": {"and":[
//					mainFilter,
//					Mozilla.BugStatus.Open.esfilter
//				]}
//			}));
//
//			aChart.show({
//				"id": "chartCount",
//				"sheetDiv": "info",
//				"type": "area",
//				"stacked": true,
//				"cube": chart,
//				"height": "300",
//				xAxisSize: 50,
//				"width": 800
//			});
//
//			Qb.normalizeByX(chart, 100);
//
//			aChart.show({
//				"name": "Regressions as Percentage",
//				"id": "chartPercent",
//				"sheetDiv": "info",
//				"type": "bar",
//				"stacked": true,
//				"cube": chart,
//				"height": "300",
//				xAxisSize: 50,
//				"width": 800
//			});
//		});


		Thread.run(function*() {
			///////////////////////////////////////////////////////////////////////
			// THREAD TO GET CLOSE RATES
			///////////////////////////////////////////////////////////////////////

			//GET BUG FINAL STATES
			var allBugs=null;
			var allBugsThread = Thread.run(function*() {
				allBugs = yield(ESQuery.run({
					"from": "bugs",
					"select": [
						"bug_id",
						"product",
						"component",
						"cf_blocking_b2g",
						"keywords",
						"target_milestone"
					],
					"esfilter": {"and": [
						mainFilter,
						Mozilla.CurrentRecords.esfilter,
						Mozilla.BugStatus.Closed.esfilter,
						{"range": {"modified_ts": {"gte": sampleMin.getMilli()}}},
						{"term":{"bug_status":"resolved"}},
						{"term":{"resolution":"fixed"}}
					]}
				}));
			});

			//PULL LATEST CLOSE DATES
			var bugClose = yield(ESQuery.run({
				"from": "bugs",
				"select": {"name": "closeDate", "value": "expires_on", "aggregate": "maximum"},
				"edges": [
					"bug_id"
				],
				"esfilter": {"and": [
					{"range": {"expires_on": {"gte": sampleMin.getMilli(), "lte": sampleMax.getMilli()}}},
					Mozilla.BugStatus.Open.esfilter,
					mainFilter
				]}
			}));

			yield (Thread.join(allBugsThread));

			{//ADD THOSE closeDate TO TO MAIN LIST OF BUGS (WE SHOULD BE MERGING IN SOME FORM)
				var domain=bugClose.edges[0].domain;
				var data = bugClose.cube;
				allBugs.list.forall(function(v){
					v.closeDate=Date.newInstance(data[domain.getPartByKey(v.bug_id).dataIndex]);    //USE dataIndex OF part TO LOOKUP closeDate IN CUBE
				});
				allBugs.columns.append({"name":"closeDate"});  //ADD TO METADATA
			}

			var churn = yield(Q({
				"from": allBugs,
				"name": "Resolved Fixed Bug Closures",
				"select": {"name":"count", "value":"bug_id", "aggregate":"count"},
				"edges": [
					{"name":"Category", "domain":Mozilla.B2G.FinalState.getDomain()},
					{"name": "date", "value":"closeDate", "domain": {"type": "time", "min": sampleMin, "max": sampleMax, "interval": sampleInterval}}
				]
			}));

			//DIRTY REVERSE OF THE
			churn.edges[0].domain.partitions.reverse();
			churn.cube.reverse();

			aChart.show({
				"id": "chartChurn",
				"sheetDiv": "info",
				"type": "bar",
				"stacked": true,
				"cube": churn,
				"height": "300",
				xAxisSize: 50,
				"width": 800,
				"clickAction": function (series, x, d) {
					var category = churn.edges[0].domain.getPartByKey(series);
					var date = churn.edges[1].domain.getPartByKey(x);

					Thread.run(function*() {
						var buglist = (yield (Qb.calc2List({
							"from": allBugs,
							"select": {"value": "bug_id"},
							"where": {"and":[
								{"range":{"closeDate":{"gte":date.min, "lt":date.max}}},
								category.fullFilter,
								mainFilter
							]}

						})));

						Bugzilla.showBugs(buglist.list);
					});
				}//click
			});
		});


	};


	$(document).ready(function () {
		GUI.setup(
				createChart,
				[
					{"id": "sampleMin", "name": "Start Date", "type": "time", "default": Date.eod().add("-18week")},
					{"id": "sampleMax", "name": "End Date", "type": "time", "default": Date.today().ceilingWeek()},
					{"id": "sampleInterval", "name": "Interval", "type": "duration", "default": "week"},
					{"id": "team", "name": "Team", "type": PartitionFilter.newInstance({
						"id": "teams",
						"name": "All Teams",
						"dimension": Mozilla.B2G.Team,
						"onlyOne": true,
						"expandAll": true
					})}
				],
				[
					"sampleMin=Date.newInstance(sampleMin).floor(Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')",
					"sampleMax=Date.newInstance(sampleMax).addDay(1).floor(Duration.newInstance(sampleInterval)).addDay(-1).format('yyyy-MM-dd')"
				],
				"bugs",
				false,		//DO NOT SHOW DEFAULT FILTERS
				false       //DO NOT PERFORM STANDARD CONSISTENCY CHECKS
		);
	});

});

</script>


</BODY>
</HTML>

