<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>

<HEAD>
	<script type="application/javascript;version=1.7" src="js/imports/import.js"></script>
</HEAD>
<BODY>

<h3>Individual Review History</h3>

<div id="sidebar">
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>

<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">HOME</a>
</div>
<div id="chart" class="chart" style="height:600px;width:800px;position:relative;"></div>

<div id="info"></div>
<div id="report"></div>

<script type="application/javascript;version=1.7">

importScript([
	"js/main.js",
	"js/etl/Reviews.js"
], function(){

	$("#description").html("Shows the pending reviews for each interval.  This can include new reviews, or reviews untouched since the previous interval.  This chart is only good for identifying individual bugs, it is not good for seeing review volume.");

	var thread;
	var createChart = function(){
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	var __createChart = function(){

		var sampleInterval = Duration.newInstance(GUI.state.sampleInterval);
		var sampleMin = Date.newInstance(GUI.state.sampleMin);//.floor(sampleInterval);
		var sampleMax = sampleMin.add(Date.newInstance(GUI.state.sampleMax).add(sampleInterval).subtract(sampleMin, sampleInterval).floor(sampleInterval));


		var esQuery = new ESQuery({
			"from":"reviews",
			"select":[
				{"name":"bug_id", "value":"reviews.bug_id"},
				{"name":"attach_id", "value":"reviews.attach_id"},
				{"name":"request_time", "value":"reviews.request_time"},
				{"name":"review_time", "value":"reviews.review_time"}
			],
			"esfilter":{"and":[
				{"term":{"reviewer":GUI.state.requestee}},
				{"range":{"request_time":{"lt":sampleMax.getMilli()}}},
				{"or":[
					{"range":{"review_time":{"gt":sampleMin.getMilli()}}},
					{"missing":{"field":"review_time"}}
				]}
			]}
		});

		console.info(CNV.Object2JSON(esQuery.esQuery));

		Log.action("Call ES");
		var reviewQueues = yield(esQuery.run());

		Log.action("Prep Chart");


		var ordering = yield(Qb.calc2List({
			"from":reviewQueues,
			"select":[
				{"value":"request_time", "aggregate":"minimum"},
				{"value":"review_time", "aggregate":"maximum"}
			],
			"edges":[
				"bug_id"
			],
			"sort":["request_time", "review_time"]
		}));


//Log.note(CNV.List2Tab(reviewQueues));

		var chart = yield(Q({
			"name":"Historical Review Queue for " + GUI.state.requestee,
			"from":reviewQueues,
			"select":{"name":"Pending", "value":"1", aggregate:"sum", "default":"0"},
			"edges":[
				{"name":"Bug ID", "value":"bug_id", "domain":{"type":"set", "partitions":ordering, "key":"bug_id", "value":"bug_id"}},
				{"name":"Date",
					"range":{"min":"Date.newInstance(request_time)", "max":"nvl(Date.newInstance(review_time), Date.eod())"},
					"domain":{"type":"time", "min":sampleMin, "max":sampleMax, "interval":sampleInterval, value:"value"}
				}
			]
		}));


		aChart.show({
			"id":"chart",
			"sheetDiv":"info",
			"type":"stacked",
			"cube":chart,
			"showLegend":false,
			extensionPoints: {
				dot_shapeRadius: 0, //USED ON CHART (CCC v1)
				line_lineWidth: 0
			}
		});


	};//createChart


	$(document).ready(function(){
		GUI.setup(createChart, [
			{"id":"requestee", "name":"Reviewer Email", "type":"text", "default":"nobody@mozilla.org"},
			{"id":"sampleMin", "name":"Sample From", "type":"time", "default":Date.today().add("-14day")},
			{"id":"sampleMax", "name":"Sample To", "type":"time", "default":Date.today()},
			{"id":"sampleInterval", "name":"Interval", "type":"duration", "default":Duration.DAY},
			{"id":"esSize", "name":"ES sample limit", "type":"integer", "default":100000}
		],
				[
					"sampleMax=GUI.fixEndDate(Date.newInstance(sampleMin), Date.newInstance(sampleMax), Duration.newInstance(sampleInterval)).format('yyyy-MM-dd')"
				],
				"reviews");
	});

});
</script>


</BODY>
</HTML>