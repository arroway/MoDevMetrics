<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>FFOS - Projects Dashboard</title>
	<script type="application/javascript" src="js/imports/import.js"></script>
</HEAD>
<BODY>

<div id="sidebar" style="width:250px;">
	<br>
	<br>

	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>
	<hr>
	<div id="description">
		<div style="display:inline-block;height:10px;width:10px;background-color:#ff7f0e;"></div>
		Over 2 days since last change<br>

		<div style="display:inline-block;height:10px;width:10px;background-color:#d62728;"></div>
		Over 1 week since last change<br>

		<div style="display:inline-block;height:10px;width:10px;background-color:#9467bd;"></div>
		Unassigned Blocker<br>
	</div>

</div>


<div style="align:left;position:relative;float:left;width:800px;padding-top: 10px;">
	<h3 id="title">FFOS Projects Dashboard</h3>

	<div>
		<div id="info" style="width:800px;"></div>

	</div>
	<div class="footer">Source at
		<a href="https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Overall.html">https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Overall.html</a></div>
</div>

<script type="application/javascript">




importScript(['js/main.js', 'js/Dimension-Bugzilla.js', "js/Dimension-B2G.js", "b2g/grid.js"], function () {
	var thread;
	var createChart = function () {
		if (thread !== undefined)
			thread.kill();
		thread = Thread.run(__createChart());
	};

	//REFRESH PERIODICALLY
	Thread.daemon(function*(){
		while(true){
			try{
				yield (Thread.sleep(5*60*1000));
				createChart();
			} catch(e){
				//do nothing
			}//try
		}//while
	});

	var __createChart = function*() {
		NOW = Date.today();
		TOO_LATE = NOW.subtract(Duration.newInstance("2day"));
		REALLY_TOO_LATE = NOW.subtract(Duration.newInstance("1week"));

		var mainFilter = {"and": [
			Mozilla.BugStatus.Open.esfilter,
			Mozilla.B2G.esfilter,
			Mozilla.CurrentRecords.esfilter
		]};

		yield (ESQuery.loadColumns({"from": "bugs"}));

		var counting = null;
		var countingThread = Thread.run(function*() {
			var a = Log.action("Get Counts", true);

			counting = yield(ESQuery.run({
				"from": "bugs",
				"select": {"name": "count", "value": "bug_id", "aggregate": "count"},
				"edges": [
					{"name": "Team", "domain": Mozilla.B2G.Team.getDomain()},
					{"name": "Project", "domain": Mozilla.B2G.Project.getDomain()},
					{"name": "State", "domain": Mozilla.B2G.State.getDomain()}
				],
				"esfilter": mainFilter
			}));
			Log.actionDone(a);
			yield (null);
		});

		var ages = null;
		var ageThread = Thread.run(function*() {
			var a = Log.action("Get Ages", true);
			ages = yield(ESQuery.run({
				"from": "bugs",
				"select": {"name": "oldest", "value": "modified_ts", "aggregate": "minimum"},
				"edges": [
					{"name": "Team", "domain": Mozilla.B2G.Team.getDomain()},
					{"name": "Project", "domain": Mozilla.B2G.Project.getDomain()},
					{"name": "State", "domain": Mozilla.B2G.State.getDomain()}
				],
				"esfilter": mainFilter
			}));
			Log.actionDone(a);
		});

		var uBlocker = null;
		var uBlockerThread = Thread.run(function*() {
			var a = Log.action("Get Unassigned Blockers", true);
			uBlocker = yield(ESQuery.run({
				"from": "bugs",
				"select": {"name": "unassigned", "value": "bug_id", "aggregate": "count"},
				"edges": [
					{"name": "Team", "domain": Mozilla.B2G.Team.getDomain()},
					{"name": "Project", "domain": Mozilla.B2G.Project.getDomain()},
					{"name": "State", "domain": Mozilla.B2G.State.getDomain()}
				],
				"esfilter": {"and": [
					mainFilter,
					{"term": {"assigned_to": "nobody@mozilla.org"}},
					{"terms": {"cf_blocking_b2g": ["1.3+", "1.4+", "1.3t+", "1.5+"]}}
				]}
			}));
			Log.actionDone(a);
		});

		yield (Thread.join(countingThread));
		yield (Thread.join(ageThread));
		yield (Thread.join(uBlockerThread));

		var both = Qb.merge([
			{"from": counting, "edges": ["Team", "Project", "State"]},
			{"from": ages, "edges": ["Team", "Project", "State"]},
			{"from": uBlocker, "edges": ["Team", "Project", "State"]}
		]);

		//EXPOSE NULLS AS LEGITIMATE PARTS
		both.edges.forall(function (edge, e) {
			if (edge.allowNulls) {
				edge.domain.partitions.append(edge.domain.NULL);
				edge.allowNulls = false;
			}//endif
		});

		both.name = "Teams";
		var html = cube2grid({
			"cube": both,
			"rows": ["Team"],
			"columns": ["Project", "State"]
		});
		$("#info").html(html);
		addNumberClickers(both, mainFilter);
		addTeamClickers(both);
	};

	$(document).ready(function () {
		GUI.setup(
				createChart,
				[],
				[],
				null,
				false		//SHOW DEFAULT FILTERS?
		);
	});
});



</script>


</BODY>
</HTML>

