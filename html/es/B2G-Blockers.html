<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>FFOS Blockers</title>
	<script type="application/javascript" src="js/imports/import.js"></script>
</HEAD>
<BODY>
<h3>FFOS Blockers</h3>
<div id="blockers"></div>
<div class="footer">
	Source at <a href="https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Regressions.html">https://github.com/klahnakoski/MoDevMetrics/blob/b2g/html/es/B2G-Regressions.html</a>
</div>

<script type="application/javascript">

	importScript([
		'b2g/blockers.css',
		'js/main.js',
		'js/Dimension-Bugzilla.js',
		"js/Dimension-B2G.js",
		"js/charts/aColor.js",
		"b2g/heat.js"
	], function () {

		Thread.run(function*(){
			while(true){
				yield(Thread.sleep(5*60*1000));
				createChart();
			}//while
		});

		var thread;
		var createChart = function () {
			if (thread !== undefined)
				thread.kill();
			thread = Thread.run(__createChart());
		};

		var __createChart = function*() {
			yield (ESQuery.loadColumns({"from": "bugs"}));

			var a = Log.action("Get Bug Details", true);
			//PULL THE RAW DATA, AND THEN OPERATE ON IT 112K, 2.17sec time
			//THE AGGREGATES ARE SPENDING ABOUT 2/3 THE TIME TRANSMITTING THE QUERY
			var allDetails = yield(ESQuery.run({
				"from": "bugs",
				"select": [
					"bug_id",
					"modified_ts",
					"keywords",
					"assigned_to",
					"component",
					"product",
					"cf_blocking_b2g"
				],
				"esfilter": {"and": [
					{"terms": {"cf_blocking_b2g": ["1.3+", "1.4+", "1.3t+"]}},
					Mozilla.BugStatus.Open.esfilter,
					Mozilla.CurrentRecords.esfilter
				]}
			}));
			Log.actionDone(a);

			var components = yield(Q({
				"from": allDetails,
				"select": [
					{"name": "count", "value": "bug_id", "aggregate": "count"},
					{"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "maximum"},
					{"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"}
				],
				"edges": [
					"component",
					{"name": "project", "domain": Mozilla.B2G.Project.getDomain()}
				]
			}));

			$("#blockers").html("");
			components.cube.forall(function (component, i) {
				var total = aMath.sum.apply(undefined, component.select("count"));
				if (total > 0) {
					component.forall(function (project, j) {
						project.component = components.edges[0].domain.partitions[i].name;
						project.project = components.edges[1].domain.partitions[j].name;
						project.total = total;
					});
					var blockerHTML = showComponent(component, showBlocker);
					$("#blockers").append(blockerHTML);
				}//endif
			});



			addProjectClickers(components);
		};

		$(document).ready(function () {
			GUI.setup(
					createChart,
					[],
					[],
					null,
					false		//DO NOT SHOW DEFAULT FILTERS
			);
		});
	});
</script>


</BODY>
</HTML>




