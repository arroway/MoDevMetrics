<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<script type="text/javascript" src="modevlib/imports/import.js"></script>
</HEAD>
<BODY>


<div style="float:right;display: inline;">
	<a href="http://people.mozilla.com/~klahnakoski/" class="button">More Charts</a>
</div>

<div id="sidebar" style="width:300px;">
	<br>
	<br>
	<div style="height: 30px; text-align: center;vertical-align:middle;">
		<span id="status" style="height:30px">Page Loading...</span><span class="loading"><img src="images/spinner.gif" alt=""></span>
	</div>

	<hr>
	<div id="description"></div>
	<hr>
	<div id="testMessage"></div>
	<hr>
	<div id="stats"></div>
	<hr>

	<div id="parameters" class="parameters">
	</div>
	<div id="filters" class="menu"></div>
</div>


<div style="align:left;position:relative;float:left;width:800px;">
	<h3 id="title"></h3>

	<div id="chart" class="chart" style="height:500px;width:800px;position: relative;"></div>
	<br><br>
	<div id="info" style="width:800px;float:left;"></div>
	<div id="report"></div>
</div>


<script type="application/javascript">



importScript(['modevlib/main.js', 'modevlib/Dimension-Bugzilla.js', 'modevlib/Dimension-B2G.js'], function(){


var thread;
var createChart = function(){
	if (thread !== undefined)
		thread.kill();
	thread = Thread.run(__createChart());
};

var __createChart = function*(){
	$("#title").html("B2G Bug Fix Rate");
	$("#description").html(
		"Show number of Resolution==FIXED bugs for four major B2G projects:<ul>"+
		"<li><b>1.5</b> - blocking-b2g==&quot;1.5+&quot; OR target_milestone.startsWith(&quot;1.5&quot;)</li>"+
		"<li><b>1.4</b> - blocking-b2g==&quot;1.4+&quot; OR target_milestone.startsWith(&quot;1.4&quot;)</li>"+
        "<li><b>1.3</b> - blocking-b2g in (&quot;1.3+&quot;, &quot;1.3t+&quot;) OR target_milestone.startsWith(&quot;1.3&quot;)</li>"+
        "<li><b>KOI</b> - blocking-b2g==&quot;koi+&quot; OR target_milestone.startsWith(&quot;1.2&quot;)</li>"+
		"<li><b>LEO</b> - blocking-b2g==&quot;leo+&quot;</li>"+
		"<li><b>HD</b> - blocking-b2g==&quot;hd+&quot;</li>"+
		"</ul><p>In the event a bug belongs to more than one project, bugs are only counted once, and preference given to the top most project in this list.</p>"+
		"<p>Only the latest, and current, resolution is counted.  Bugs that have opened and closed multiple times will only count once, at the latest closed time.</p>"+
		'<p class="warning">If closed bugs have their projects cleared after being closed, they will be removed from this chart.</p>'
	);


	var sampleMin = Date.newInstance(GUI.state.sampleMin);
	var sampleMax =Date.newInstance(GUI.state.sampleMax).addDay(1);
	var sampleInterval = Duration.WEEK;

	var focal_dim={"name":"Project", "edges":[]};
	Dimension.addEdges(true, focal_dim, [
		{"name": "Project", "index": "bugs", "isFacet": true, "partitions": [
			{"name": "1.5/2.0", "esfilter": {"or": [
				{"and": [
					{"exists": {"field": "target_milestone"}},
					{"prefix": {"target_milestone": "1.5"}},
					{"term": {"product": "firefox os"}}
				]},
				{"terms": {"cf_blocking_b2g": ["1.5+"]}}
			]}},
			{"name": "1.4", "esfilter": {"or": [
				{"and": [
					{"exists": {"field": "target_milestone"}},
					{"prefix": {"target_milestone": "1.4"}},
					{"term": {"product": "firefox os"}}
				]},
				{"terms": {"cf_blocking_b2g": ["1.4+"]}}
			]}},
			{"name": "1.3/1.3T", "esfilter": {"or": [
				{"and": [
					{"exists": {"field": "target_milestone"}},
					{"prefix": {"target_milestone": "1.3"}},
					{"term": {"product": "firefox os"}}
				]},
				{"terms": {"cf_blocking_b2g": ["1.3+", "1.3t+"]}}
			]}},
			{"name":"KOI", "esfilter":{"or":[
                {"and":[
                    {"exists":{"field":"target_milestone"}},
                    {"prefix":{"target_milestone":"1.2"}},
	                {"term":{"product": "firefox os"}}
                ]},
                {"terms":{"cf_blocking_b2g":["koi+"]}}
            ]}},
			{"name":"LEO", "esfilter":{"terms":{"cf_blocking_b2g":["leo+"]}}},
			{"name":"HD", "esfilter":{"terms":{"cf_blocking_b2g":["hd+"]}}}
		]}
	]);

	yield (ESQuery.loadColumns({"from":"bugs"}));

	Thread.run(function*() {
		///////////////////////////////////////////////////////////////////////
		// THREAD TO GET CLOSE RATES
		///////////////////////////////////////////////////////////////////////

		var a = Log.action("Load Bug Closures", true);
		//GET BUG FINAL STATES
		var allBugs = null;
		var allBugsThread = Thread.run(function*() {
			allBugs = yield(ESQuery.run({
				"from": "bugs",
				"select": [
					"bug_id",
					"product",
					"component",
					"cf_blocking_b2g",
					"keywords",
					"target_milestone"
				],
				"esfilter": {"and": [
					focal_dim.Project.esfilter,
					Mozilla.CurrentRecords.esfilter,
					Mozilla.BugStatus.Closed.esfilter,
					{"range": {"modified_ts": {"gte": sampleMin.getMilli()}}},
					{"term": {"bug_status": "resolved"}},
					{"term": {"resolution": "fixed"}}
				]}
			}));
		});

		//PULL LATEST CLOSE DATES
		var bugClose = yield(ESQuery.run({
			"from": "bugs",
			"select": {"name": "closeDate", "value": "expires_on", "aggregate": "maximum"},
			"edges": [
				"bug_id"
			],
			"esfilter": {"and": [
				{"range": {"expires_on": {"gte": sampleMin.getMilli(), "lte": sampleMax.getMilli()}}},
				Mozilla.BugStatus.Open.esfilter,
				focal_dim.Project.esfilter
			]}
		}));

		yield (Thread.join(allBugsThread));
		Log.actionDone(a);

		{//ADD THOSE closeDate TO TO MAIN LIST OF BUGS (WE SHOULD BE MERGING IN SOME FORM)
			var domain = bugClose.edges[0].domain;
			var data = bugClose.cube;
			allBugs.list.forall(function (v) {
				v.closeDate = Date.newInstance(data[domain.getPartByKey(v.bug_id).dataIndex]);    //USE dataIndex OF part TO LOOKUP closeDate IN CUBE
			});
			allBugs.columns.append({"name": "closeDate"});  //ADD TO METADATA
		}

		var churn = yield(Q({
			"from": allBugs,
			"name": "Resolved Fixed Bugs",
			"select": {"name": "count", "value": "bug_id", "aggregate": "count"},
			"edges": [
				{"name": "Category", "domain": focal_dim.Project.getDomain()},
				{"name": "date", "value": "closeDate", "domain": {"type":"time", "min":sampleMin, "max":sampleMax, "interval":sampleInterval}}
			]
		}));

//		//DIRTY REVERSE OF THE TYPES
//		churn.edges[0].domain.partitions.reverse();
//		churn.cube.reverse();
//		churn.edges[0].domain.partitions[0].style.visibility = "visible";

		aChart.show({
			"id": "chart",
			"type": "bar",
			"stacked": true,
			"cube": churn,
			"clickAction": function (series, x, d) {
				var category = churn.edges[0].domain.getPartByKey(series);
				var date = churn.edges[1].domain.getPartByKey(x);

				Thread.run(function*() {
					var buglist = (yield (Qb.calc2List({
						"from": allBugs,
						"select": {"value": "bug_id"},
						"where": {"and": [
							{"range": {"closeDate": {"gte": date.min, "lt": date.max}}},
							category.fullFilter,
							GUI.getFilters("bugs")
						]}

					})));

					Bugzilla.showBugs(buglist.list);
				});
			}//click
		});
	});





};


$(document).ready(function(){
	GUI.setup(createChart, [
		{"id":"sampleMin", "name":"Start Date", "type":"time", "default":Date.eod().addMonth(-2)},//Date.now().addDay(-15).floorMonth()},
		{"id":"sampleMax", "name":"End Date", "type":"time", "default":Date.eod()}//Date.now().addMonth(1).floorDay()},
		],
		[
				"sampleMin=Date.newInstance(sampleMin).floorWeek().format('yyyy-MM-dd')",
				"sampleMax=Date.newInstance(sampleMax).addDay(1).floorWeek().addDay(-1).format('yyyy-MM-dd')"
		],
		"bugs",
		false		//SHOW DEFAULT FILTERS?
	);

//	GUI.state.productFilter = ["B2G 1.0.0 (TEF)"];

});


});
</script>


</BODY>
</HTML>

